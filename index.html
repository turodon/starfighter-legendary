<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>STARFIGHTER LEGENDARY</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: white; cursor: crosshair; }

    /* Overlays */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    #damageOverlay { background: radial-gradient(ellipse at center, transparent 40%, rgba(255,0,50,0.6) 100%); opacity: 0; }
    #shieldOverlay { background: radial-gradient(ellipse at center, rgba(0,200,255,0.2) 0%, transparent 60%); opacity: 0; }
    #boostOverlay { background: radial-gradient(ellipse at center, transparent 30%, rgba(100,150,255,0.15) 100%); opacity: 0; }
    #lowHealthOverlay { background: radial-gradient(ellipse at center, transparent 50%, rgba(255,0,0,0.3) 100%); opacity: 0; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 0; } 50% { opacity: 0.5; } }

    /* Cockpit HUD */
    #cockpitHUD {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 50; display: none;
    }
    .cockpit-frame {
      position: absolute; bottom: 0; left: 0; right: 0; height: 25%;
      background: linear-gradient(to top, rgba(20,30,20,0.9), transparent);
      border-top: 2px solid rgba(0,255,136,0.3);
    }
    .cockpit-left, .cockpit-right {
      position: absolute; top: 0; bottom: 0; width: 8%;
      background: linear-gradient(to right, rgba(20,30,20,0.7), transparent);
    }
    .cockpit-left { left: 0; }
    .cockpit-right { right: 0; background: linear-gradient(to left, rgba(20,30,20,0.7), transparent); }
    .cockpit-gauge {
      position: absolute; width: 120px; padding: 10px;
      background: rgba(0,20,10,0.8); border: 1px solid rgba(0,255,136,0.4); border-radius: 5px;
    }
    .cockpit-gauge.speed { bottom: 30px; left: 30px; }
    .cockpit-gauge.weapons { bottom: 30px; right: 30px; }
    .cockpit-gauge.target { top: 100px; right: 30px; }
    .gauge-label { font-size: 10px; color: #00aa66; }
    .gauge-value { font-size: 18px; color: #00ff88; text-shadow: 0 0 10px #00ff88; }

    /* HUD */
    #hud { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

    .panel {
      background: rgba(0,15,10,0.75);
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 8px;
      padding: 12px;
    }

    /* Stats panel */
    .stats-panel { position: absolute; top: 15px; left: 15px; }
    .stat-row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 12px; }
    .stat-label { color: #00ff88; }
    .stat-value { color: #fff; min-width: 50px; text-align: right; }

    /* Bars */
    .bar-group { margin-top: 8px; }
    .bar-label { font-size: 10px; color: #666; margin-bottom: 2px; }
    .bar-container { width: 160px; height: 12px; background: rgba(0,0,0,0.6); border: 1px solid #333; border-radius: 6px; overflow: hidden; margin-bottom: 5px; }
    .bar-fill { height: 100%; transition: width 0.2s; border-radius: 5px; }
    .bar-fill.health { background: linear-gradient(90deg, #ff0055, #ff4477); }
    .bar-fill.shield { background: linear-gradient(90deg, #00aaff, #44ddff); }
    .bar-fill.boost { background: linear-gradient(90deg, #ffaa00, #ffcc44); }
    .bar-fill.energy { background: linear-gradient(90deg, #8800ff, #aa44ff); }

    /* Score panel */
    .score-panel { position: absolute; top: 15px; right: 15px; text-align: right; }
    .score-big { font-size: 28px; color: #00ff88; text-shadow: 0 0 15px rgba(0,255,136,0.5); }
    .combo-display { font-size: 20px; color: #ffaa00; margin-top: 3px; }
    .credits-display { font-size: 14px; color: #ffff00; margin-top: 8px; }
    .rank-display { font-size: 11px; color: #00aaff; margin-top: 5px; }

    /* Mission panel */
    .mission-panel {
      position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
      text-align: center; min-width: 250px;
    }
    .mission-type { font-size: 10px; color: #888; }
    .mission-name { font-size: 14px; color: #00ff88; margin: 3px 0; }
    .mission-objective { font-size: 12px; color: #ffaa00; }
    .mission-progress { margin-top: 5px; }
    .mission-bar { width: 200px; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; margin: 0 auto; }
    .mission-fill { height: 100%; background: #00ff88; transition: width 0.3s; }

    /* Weapon panel */
    .weapon-panel { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; }
    .weapon-name { font-size: 16px; text-shadow: 0 0 12px currentColor; }
    .weapon-info { font-size: 10px; color: #666; margin-top: 3px; }
    .weapon-slots { display: flex; gap: 6px; justify-content: center; margin-top: 8px; }
    .weapon-slot {
      width: 36px; height: 36px; background: rgba(0,0,0,0.5); border: 2px solid #333;
      border-radius: 6px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; color: #555; position: relative;
    }
    .weapon-slot.active { border-color: #00ff88; box-shadow: 0 0 8px rgba(0,255,136,0.5); color: #00ff88; }
    .weapon-slot.locked { opacity: 0.3; }
    .weapon-slot .key { position: absolute; bottom: -12px; font-size: 8px; color: #444; }
    .weapon-slot .charge { position: absolute; bottom: 0; left: 0; height: 3px; background: #ff00ff; width: 0; }

    /* Radar */
    .radar-panel { position: absolute; bottom: 20px; right: 20px; padding: 0; background: none; border: none; }
    #radarCanvas { width: 150px; height: 150px; background: rgba(0,20,10,0.7); border: 2px solid rgba(0,255,136,0.4); border-radius: 50%; }

    /* Speed */
    .speed-panel { position: absolute; bottom: 20px; left: 15px; }
    .speed-value { font-size: 24px; color: #00ff88; }
    .speed-unit { font-size: 10px; color: #666; }

    /* Wingman status */
    .wingman-panel { position: absolute; top: 150px; left: 15px; }
    .wingman-entry { display: flex; align-items: center; gap: 8px; margin: 5px 0; font-size: 11px; }
    .wingman-icon { width: 20px; height: 20px; background: #00aa66; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .wingman-icon.dead { background: #660000; }
    .wingman-name { color: #00ff88; }
    .wingman-status { color: #888; font-size: 10px; }

    /* Target info */
    .target-panel { position: absolute; top: 100px; right: 15px; min-width: 150px; display: none; }
    .target-name { color: #ff0055; font-size: 14px; margin-bottom: 5px; }
    .target-health-bar { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; }
    .target-health-fill { height: 100%; background: #ff0055; }
    .target-distance { font-size: 10px; color: #888; margin-top: 3px; }

    /* Boss UI */
    #bossUI { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); width: 350px; display: none; flex-direction: column; align-items: center; }
    .boss-name { font-size: 16px; color: #ff0055; text-shadow: 0 0 15px rgba(255,0,85,0.7); margin-bottom: 5px; }
    .boss-bar { width: 100%; height: 14px; background: rgba(0,0,0,0.7); border: 1px solid #ff0055; border-radius: 7px; overflow: hidden; }
    .boss-fill { height: 100%; background: linear-gradient(90deg, #ff0055, #ff4488); transition: width 0.2s; }
    .boss-phase { font-size: 10px; color: #ff8888; margin-top: 3px; }

    /* Radio messages */
    #radioMessages {
      position: absolute; bottom: 200px; left: 15px; width: 280px;
      max-height: 150px; overflow: hidden;
    }
    .radio-msg {
      background: rgba(0,20,10,0.8); border-left: 3px solid #00ff88;
      padding: 8px 12px; margin-bottom: 5px; font-size: 11px;
      animation: radioFade 5s forwards;
    }
    .radio-msg .sender { color: #00ff88; font-size: 10px; }
    .radio-msg .text { color: #ccc; margin-top: 2px; }
    @keyframes radioFade { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }

    /* Crosshair */
    #crosshair {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 50px; height: 50px; pointer-events: none; z-index: 200;
    }
    .ch-ring { position: absolute; border: 2px solid rgba(0,255,136,0.5); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .ch-ring.outer { width: 40px; height: 40px; }
    .ch-ring.inner { width: 16px; height: 16px; border-color: rgba(0,255,136,0.7); }
    .ch-dot { position: absolute; width: 4px; height: 4px; background: #00ff88; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 8px #00ff88; }

    /* Lock indicator */
    #lockIndicator {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 70px; height: 70px; border: 2px solid transparent; pointer-events: none; z-index: 199;
    }
    #lockIndicator.locking { border-color: #ffaa00; animation: lockPulse 0.3s infinite; }
    #lockIndicator.locked { border-color: #ff0055; animation: lockedPulse 0.5s infinite; }
    @keyframes lockPulse { 0%,100% { transform: translate(-50%,-50%) scale(1); } 50% { transform: translate(-50%,-50%) scale(1.1); } }
    @keyframes lockedPulse { 0%,100% { transform: translate(-50%,-50%) scale(1); opacity:1; } 50% { transform: translate(-50%,-50%) scale(0.9); opacity:0.7; } }

    /* Announcements */
    #announcement {
      position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
      font-size: 40px; font-weight: bold; text-shadow: 0 0 30px currentColor;
      opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 300;
    }

    /* Voice text */
    #voiceText {
      position: fixed; bottom: 25%; left: 50%; transform: translateX(-50%);
      font-size: 18px; color: #00ff88; text-shadow: 0 0 15px #00ff88;
      opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 250;
    }

    /* View indicator */
    #viewIndicator {
      position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
      font-size: 12px; color: #666; z-index: 100;
    }

    /* Screens */
    .screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.97); display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 500;
    }
    .screen.hidden { display: none; }
    .screen h1 { font-size: 3.5rem; color: #00ff88; text-shadow: 0 0 50px #00ff88; margin-bottom: 5px; }
    .screen h2 { font-size: 2rem; margin-bottom: 15px; }
    .screen .subtitle { font-size: 1rem; color: #00aa66; margin-bottom: 25px; }
    .screen p { color: #666; margin: 5px 0; font-size: 0.9rem; }
    .screen .highlight { color: #00ff88; }

    .btn {
      padding: 12px 40px; font-size: 1.1rem;
      background: linear-gradient(135deg, #00ff88, #00cc66);
      color: #000; border: none; border-radius: 25px; cursor: pointer;
      font-weight: bold; font-family: inherit; margin: 8px; transition: all 0.3s;
      pointer-events: auto;
    }
    .btn:hover { transform: scale(1.08); box-shadow: 0 0 30px #00ff88; }
    .btn.secondary { background: linear-gradient(135deg, #8800ff, #6600cc); }
    .btn.small { padding: 8px 20px; font-size: 0.9rem; }

    /* Menu grid */
    .menu-grid { display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }
    .menu-card {
      width: 180px; padding: 20px; background: rgba(0,30,20,0.8);
      border: 2px solid #00aa66; border-radius: 12px; text-align: center;
      cursor: pointer; transition: all 0.2s; pointer-events: auto;
    }
    .menu-card:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,136,0.4); border-color: #00ff88; }
    .menu-card h3 { color: #00ff88; font-size: 1rem; margin-bottom: 8px; }
    .menu-card p { color: #888; font-size: 0.75rem; }
    .menu-card.locked { opacity: 0.4; cursor: not-allowed; }
    .menu-card.locked:hover { transform: none; box-shadow: none; }

    /* Ship select */
    .ship-select { display: flex; gap: 20px; margin: 20px 0; }
    .ship-card {
      width: 200px; padding: 15px; background: rgba(0,30,20,0.8);
      border: 2px solid #333; border-radius: 10px; text-align: center;
      cursor: pointer; transition: all 0.2s; pointer-events: auto;
    }
    .ship-card:hover { border-color: #00aa66; }
    .ship-card.selected { border-color: #00ff88; box-shadow: 0 0 15px rgba(0,255,136,0.4); }
    .ship-card.locked { opacity: 0.4; }
    .ship-preview { height: 80px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
    .ship-preview canvas { max-width: 100%; max-height: 100%; }
    .ship-name { color: #00ff88; font-size: 14px; }
    .ship-stats { font-size: 10px; color: #888; margin-top: 5px; }
    .ship-unlock { font-size: 10px; color: #ffaa00; margin-top: 5px; }

    /* Settings */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 500px; margin: 20px; }
    .setting-item { text-align: left; }
    .setting-label { font-size: 12px; color: #00ff88; margin-bottom: 5px; }
    .setting-slider { width: 100%; }
    .setting-toggle { display: flex; align-items: center; gap: 10px; }
    .toggle-btn {
      width: 50px; height: 26px; background: #333; border-radius: 13px;
      position: relative; cursor: pointer; pointer-events: auto;
    }
    .toggle-btn.on { background: #00aa66; }
    .toggle-btn::after {
      content: ''; position: absolute; width: 22px; height: 22px;
      background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: left 0.2s;
    }
    .toggle-btn.on::after { left: 26px; }

    /* Stats page */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 600px; margin: 20px; }
    .stats-card { background: rgba(0,30,20,0.8); border: 1px solid #00aa66; border-radius: 8px; padding: 15px; text-align: center; }
    .stats-card .value { font-size: 24px; color: #00ff88; }
    .stats-card .label { font-size: 11px; color: #888; margin-top: 5px; }

    /* Controls hint */
    #controlsHint { position: fixed; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #333; z-index: 100; }

    /* Tutorial */
    .tutorial-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 600; display: none;
      align-items: center; justify-content: center;
    }
    .tutorial-box {
      background: rgba(0,30,20,0.95); border: 2px solid #00ff88;
      border-radius: 15px; padding: 30px; max-width: 500px; text-align: center;
    }
    .tutorial-box h3 { color: #00ff88; margin-bottom: 15px; }
    .tutorial-box p { color: #ccc; margin: 10px 0; font-size: 14px; }
    .tutorial-box .keys { color: #ffaa00; font-size: 16px; margin: 15px 0; }

    /* Mobile Touch Controls */
    #mobileControls { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; }
    #mobileControls.active { display: block; }

    .touch-joystick {
      position: absolute; bottom: 30px; left: 30px;
      width: 140px; height: 140px; pointer-events: auto; touch-action: none;
    }
    .joystick-base {
      width: 140px; height: 140px; background: rgba(0,255,136,0.1);
      border: 2px solid rgba(0,255,136,0.3); border-radius: 50%;
      position: relative;
    }
    .joystick-thumb {
      width: 50px; height: 50px; background: rgba(0,255,136,0.4);
      border: 2px solid rgba(0,255,136,0.7); border-radius: 50%;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      transition: none;
    }

    .touch-btn {
      position: absolute; pointer-events: auto; touch-action: none;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-family: 'Courier New', monospace; font-weight: bold; user-select: none;
      -webkit-user-select: none; -webkit-tap-highlight-color: transparent;
    }
    .touch-btn:active { transform: scale(0.9); }

    #fireBtn {
      bottom: 40px; right: 40px; width: 90px; height: 90px;
      background: rgba(255,0,85,0.3); border: 3px solid rgba(255,0,85,0.7);
      color: #ff0055; font-size: 12px;
    }
    #fireBtn.active { background: rgba(255,0,85,0.6); box-shadow: 0 0 20px rgba(255,0,85,0.5); }

    #boostBtn {
      bottom: 150px; right: 50px; width: 60px; height: 60px;
      background: rgba(255,170,0,0.2); border: 2px solid rgba(255,170,0,0.5);
      color: #ffaa00; font-size: 10px;
    }
    #boostBtn.active { background: rgba(255,170,0,0.5); box-shadow: 0 0 15px rgba(255,170,0,0.5); }

    #thrustBtn {
      bottom: 150px; left: 40px; width: 60px; height: 60px;
      background: rgba(0,255,136,0.2); border: 2px solid rgba(0,255,136,0.5);
      color: #00ff88; font-size: 10px;
    }
    #thrustBtn.active { background: rgba(0,255,136,0.5); }

    #lockBtn {
      bottom: 230px; right: 55px; width: 50px; height: 50px;
      background: rgba(0,170,255,0.2); border: 2px solid rgba(0,170,255,0.5);
      color: #00aaff; font-size: 9px;
    }

    .touch-weapon-bar {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 5px; pointer-events: auto;
    }
    .touch-weapon-btn {
      width: 38px; height: 38px; background: rgba(0,0,0,0.5); border: 2px solid #333;
      border-radius: 8px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; color: #555; font-family: 'Courier New', monospace;
      pointer-events: auto; touch-action: none; -webkit-tap-highlight-color: transparent;
    }
    .touch-weapon-btn.active { border-color: #00ff88; color: #00ff88; box-shadow: 0 0 8px rgba(0,255,136,0.5); }
    .touch-weapon-btn.locked { opacity: 0.3; pointer-events: none; }

    /* Mobile HUD adjustments */
    @media (max-width: 768px), (hover: none) and (pointer: coarse) {
      .stats-panel { top: 8px; left: 8px; }
      .stat-row { font-size: 10px; }
      .bar-container { width: 100px; height: 8px; }
      .score-panel { top: 8px; right: 8px; }
      .score-big { font-size: 18px; }
      .combo-display { font-size: 14px; }
      .mission-panel { top: 5px; min-width: 180px; }
      .mission-name { font-size: 11px; }
      .mission-objective { font-size: 10px; }
      .mission-bar { width: 140px; }
      .weapon-panel { bottom: 55px; }
      .weapon-name { font-size: 12px; }
      .weapon-slots { display: none; }
      .radar-panel { bottom: 70px; right: 10px; }
      #radarCanvas { width: 100px; height: 100px; }
      .speed-panel { display: none; }
      .wingman-panel { display: none; }
      .target-panel { top: 70px; right: 8px; }
      #radioMessages { display: none; }
      #controlsHint { display: none; }
      #bossUI { width: 250px; top: 55px; }
      .boss-name { font-size: 12px; }
      #announcement { font-size: 24px; }
      #voiceText { font-size: 14px; }
      .screen h1 { font-size: 2rem; }
      .screen h2 { font-size: 1.3rem; }
      .menu-card { width: 130px; padding: 12px; }
      .menu-card h3 { font-size: 0.85rem; }
      .menu-card p { font-size: 0.65rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    }
  </style>
</head>
<body>
  <!-- Overlays -->
  <div id="damageOverlay" class="overlay"></div>
  <div id="shieldOverlay" class="overlay"></div>
  <div id="boostOverlay" class="overlay"></div>
  <div id="lowHealthOverlay" class="overlay"></div>

  <!-- Cockpit HUD -->
  <div id="cockpitHUD">
    <div class="cockpit-frame"></div>
    <div class="cockpit-left"></div>
    <div class="cockpit-right"></div>
    <div class="cockpit-gauge speed">
      <div class="gauge-label">SPEED</div>
      <div class="gauge-value"><span id="cockpitSpeed">0</span> M/S</div>
    </div>
    <div class="cockpit-gauge weapons">
      <div class="gauge-label">WEAPON</div>
      <div class="gauge-value" id="cockpitWeapon">LASER</div>
    </div>
    <div class="cockpit-gauge target">
      <div class="gauge-label">TARGET</div>
      <div class="gauge-value" id="cockpitTarget">---</div>
    </div>
  </div>

  <!-- Crosshair -->
  <div id="crosshair">
    <div class="ch-ring outer"></div>
    <div class="ch-ring inner"></div>
    <div class="ch-dot"></div>
  </div>
  <div id="lockIndicator"></div>

  <!-- HUD -->
  <div id="hud">
    <div class="stats-panel panel">
      <div class="stat-row"><span class="stat-label">LEVEL</span><span class="stat-value" id="level">1</span></div>
      <div class="stat-row"><span class="stat-label">KILLS</span><span class="stat-value" id="kills">0</span></div>
      <div class="stat-row"><span class="stat-label">WAVE</span><span class="stat-value" id="wave">1</span></div>
      <div class="bar-group">
        <div class="bar-label">HULL</div>
        <div class="bar-container"><div class="bar-fill health" id="healthBar" style="width:100%"></div></div>
        <div class="bar-label">SHIELD</div>
        <div class="bar-container"><div class="bar-fill shield" id="shieldBar" style="width:100%"></div></div>
        <div class="bar-label">BOOST</div>
        <div class="bar-container"><div class="bar-fill boost" id="boostBar" style="width:100%"></div></div>
        <div class="bar-label">ENERGY</div>
        <div class="bar-container"><div class="bar-fill energy" id="energyBar" style="width:100%"></div></div>
      </div>
    </div>

    <div class="score-panel panel">
      <div class="score-big" id="score">0</div>
      <div class="combo-display">x<span id="combo">1</span></div>
      <div class="credits-display">$<span id="credits">0</span></div>
      <div class="rank-display">RANK: <span id="rank">ROOKIE</span></div>
    </div>

    <div class="mission-panel panel" id="missionPanel">
      <div class="mission-type" id="missionType">WAVE 1</div>
      <div class="mission-name" id="missionName">PATROL SECTOR</div>
      <div class="mission-objective" id="missionObj">Eliminate all hostiles</div>
      <div class="mission-progress">
        <div class="mission-bar"><div class="mission-fill" id="missionFill" style="width:0%"></div></div>
      </div>
    </div>

    <div class="wingman-panel panel" id="wingmanPanel">
      <div style="font-size:10px;color:#666;margin-bottom:5px;">WINGMEN</div>
      <div id="wingmanList"></div>
    </div>

    <div class="target-panel panel" id="targetPanel">
      <div class="target-name" id="targetName">---</div>
      <div class="target-health-bar"><div class="target-health-fill" id="targetHealth" style="width:100%"></div></div>
      <div class="target-distance" id="targetDist">0m</div>
    </div>

    <div id="bossUI">
      <div class="boss-name" id="bossName">BOSS</div>
      <div class="boss-bar"><div class="boss-fill" id="bossHealthBar" style="width:100%"></div></div>
      <div class="boss-phase" id="bossPhase">PHASE 1</div>
    </div>

    <div class="weapon-panel panel">
      <div class="weapon-name" id="weaponName" style="color:#00ff88">LASER</div>
      <div class="weapon-info" id="weaponInfo">RAPID FIRE</div>
      <div class="weapon-slots" id="weaponSlots"></div>
    </div>

    <div class="speed-panel panel">
      <div class="speed-value"><span id="speed">0</span></div>
      <div class="speed-unit">M/S</div>
    </div>

    <div class="radar-panel">
      <canvas id="radarCanvas" width="150" height="150"></canvas>
    </div>

    <div id="radioMessages"></div>
  </div>

  <div id="announcement"></div>
  <div id="voiceText"></div>
  <div id="viewIndicator">THIRD PERSON [V to toggle]</div>
  <div id="controlsHint">WASD=Fly | Mouse=Aim | Click=Fire | 1-5=Weapons | Shift=Boost | Tab=Lock | V=View | B=Shop</div>

  <!-- Mobile Touch Controls -->
  <div id="mobileControls">
    <div class="touch-joystick" id="joystickArea">
      <div class="joystick-base" id="joystickBase">
        <div class="joystick-thumb" id="joystickThumb"></div>
      </div>
    </div>
    <div class="touch-btn" id="fireBtn">FIRE</div>
    <div class="touch-btn" id="boostBtn">BOOST</div>
    <div class="touch-btn" id="thrustBtn">FWD</div>
    <div class="touch-btn" id="lockBtn">LOCK</div>
    <div class="touch-weapon-bar" id="touchWeaponBar"></div>
  </div>

  <!-- Pilot Name Entry -->
  <div id="nameScreen" class="screen">
    <h1>STARFIGHTER</h1>
    <div class="subtitle">L E G E N D A R Y</div>
    <p style="margin:20px 0 10px;color:#00ff88;">ENTER YOUR CALLSIGN, PILOT</p>
    <input type="text" id="pilotNameInput" maxlength="12" placeholder="CALLSIGN"
      style="pointer-events:auto;padding:12px 25px;font-size:1.2rem;background:rgba(0,30,20,0.9);border:2px solid #00ff88;
      border-radius:8px;color:#00ff88;text-align:center;font-family:inherit;letter-spacing:3px;width:250px;outline:none;">
    <button class="btn" id="nameConfirmBtn" style="margin-top:15px;">CONFIRM</button>
    <button class="btn small secondary" id="leaderboardBtn" style="margin-top:10px;">VIEW LEADERBOARD</button>
  </div>

  <!-- Main Menu -->
  <div id="mainMenu" class="screen hidden">
    <h1>STARFIGHTER</h1>
    <div class="subtitle">L E G E N D A R Y</div>
    <p style="color:#00ff88;margin-bottom:15px;">PILOT: <span id="pilotNameDisplay">---</span></p>
    <div class="menu-grid">
      <div class="menu-card" id="menuCampaign">
        <h3>CAMPAIGN</h3>
        <p>Story missions with objectives</p>
      </div>
      <div class="menu-card" id="menuSurvival">
        <h3>SURVIVAL</h3>
        <p>Endless waves of enemies</p>
      </div>
      <div class="menu-card" id="menuTimeAttack">
        <h3>TIME ATTACK</h3>
        <p>Score as much as possible</p>
      </div>
      <div class="menu-card" id="menuBossRush">
        <h3>BOSS RUSH</h3>
        <p>Fight bosses back to back</p>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button class="btn small" id="menuHangar">HANGAR</button>
      <button class="btn small" id="menuStats">STATS</button>
      <button class="btn small" id="menuSettings">SETTINGS</button>
      <button class="btn small" id="menuTutorial">TUTORIAL</button>
      <button class="btn small" id="menuLeaderboard">LEADERBOARD</button>
    </div>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboardScreen" class="screen hidden">
    <h2 style="color:#00ff88;">TOP PILOTS</h2>
    <div id="leaderboardList" style="margin:20px 0;max-width:500px;width:100%;"></div>
    <button class="btn" id="leaderboardBack">BACK</button>
  </div>

  <!-- Score Card (hidden canvas for generation) -->
  <canvas id="scoreCardCanvas" width="600" height="400" style="display:none;"></canvas>

  <!-- Hangar -->
  <div id="hangarScreen" class="screen hidden">
    <h2 style="color:#00ff88">HANGAR</h2>
    <p>Select your ship and customize</p>
    <div class="ship-select" id="shipSelect"></div>
    <div style="margin:15px 0;">
      <span style="color:#888;font-size:12px;">SHIP COLOR: </span>
      <input type="color" id="shipColor" value="#00ff88" style="pointer-events:auto;">
    </div>
    <button class="btn" id="hangarBack">BACK</button>
  </div>

  <!-- Stats -->
  <div id="statsScreen" class="screen hidden">
    <h2 style="color:#00ff88">PILOT STATISTICS</h2>
    <div class="stats-grid" id="statsGrid"></div>
    <button class="btn" id="statsBack">BACK</button>
  </div>

  <!-- Settings -->
  <div id="settingsScreen" class="screen hidden">
    <h2 style="color:#00ff88">SETTINGS</h2>
    <div class="settings-grid">
      <div class="setting-item">
        <div class="setting-label">MOUSE SENSITIVITY</div>
        <input type="range" class="setting-slider" id="sensitivitySlider" min="1" max="10" value="5" style="pointer-events:auto;">
      </div>
      <div class="setting-item">
        <div class="setting-label">MASTER VOLUME</div>
        <input type="range" class="setting-slider" id="volumeSlider" min="0" max="100" value="50" style="pointer-events:auto;">
      </div>
      <div class="setting-item">
        <div class="setting-label">VOICE ALERTS</div>
        <div class="setting-toggle">
          <div class="toggle-btn on" id="voiceToggle"></div>
          <span style="font-size:12px;">Enabled</span>
        </div>
      </div>
      <div class="setting-item">
        <div class="setting-label">MUSIC</div>
        <div class="setting-toggle">
          <div class="toggle-btn on" id="musicToggle"></div>
          <span style="font-size:12px;">Enabled</span>
        </div>
      </div>
      <div class="setting-item">
        <div class="setting-label">GRAPHICS QUALITY</div>
        <select id="graphicsSelect" style="pointer-events:auto;padding:5px;background:#222;color:#fff;border:1px solid #00aa66;">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div class="setting-item">
        <div class="setting-label">SHOW FPS</div>
        <div class="setting-toggle">
          <div class="toggle-btn" id="fpsToggle"></div>
          <span style="font-size:12px;">Disabled</span>
        </div>
      </div>
    </div>
    <button class="btn" id="settingsBack">BACK</button>
  </div>

  <!-- Tutorial -->
  <div id="tutorialScreen" class="screen hidden">
    <div class="tutorial-box">
      <h3 id="tutorialTitle">FLIGHT CONTROLS</h3>
      <p id="tutorialText">Use your mouse to aim and look around. Your ship will follow your aim.</p>
      <div class="keys" id="tutorialKeys">MOUSE = AIM</div>
      <button class="btn small" id="tutorialNext">NEXT</button>
      <button class="btn small secondary" id="tutorialSkip">SKIP</button>
    </div>
  </div>

  <!-- Game Over -->
  <div id="gameOverScreen" class="screen hidden">
    <h2 style="color:#ff0055">MISSION FAILED</h2>
    <p>Score: <span id="finalScore" class="highlight">0</span></p>
    <p>Kills: <span id="finalKills" class="highlight">0</span></p>
    <p>Best Combo: <span style="color:#ffaa00" id="finalCombo">0</span>x</p>
    <p>Credits Earned: <span style="color:#ffff00" id="finalCredits">0</span></p>
    <p style="color:#00aaff;">Rank Progress: +<span id="xpGained">0</span> XP</p>
    <div id="scoreCardPreview" style="margin:15px 0;display:none;">
      <img id="scoreCardImg" style="max-width:400px;border:2px solid #00ff88;border-radius:10px;">
    </div>
    <div style="margin-top:15px;display:flex;gap:10px;">
      <button class="btn" id="retryBtn">RETRY</button>
      <button class="btn small" id="shareBtn" style="background:linear-gradient(135deg,#0088ff,#0055cc);">SHARE SCORE CARD</button>
      <button class="btn secondary" id="menuBtn">MENU</button>
    </div>
  </div>

  <!-- Victory -->
  <div id="victoryScreen" class="screen hidden">
    <h2 style="color:#00ff88">MISSION COMPLETE</h2>
    <p>Score: <span id="victoryScore" class="highlight">0</span></p>
    <p>Kills: <span id="victoryKills" class="highlight">0</span></p>
    <p>Best Combo: <span style="color:#ffaa00" id="victoryCombo">0</span>x</p>
    <p>Credits Earned: <span style="color:#ffff00" id="victoryCredits">0</span></p>
    <p style="color:#00aaff;">Rank Progress: +<span id="victoryXP">0</span> XP</p>
    <div id="victoryCardPreview" style="margin:15px 0;display:none;">
      <img id="victoryCardImg" style="max-width:400px;border:2px solid #00ff88;border-radius:10px;">
    </div>
    <div style="margin-top:15px;display:flex;gap:10px;">
      <button class="btn" id="nextMissionBtn">NEXT MISSION</button>
      <button class="btn small" id="victoryShareBtn" style="background:linear-gradient(135deg,#0088ff,#0055cc);">SHARE SCORE CARD</button>
      <button class="btn secondary" id="victoryMenuBtn">MENU</button>
    </div>
  </div>

  <!-- Pause -->
  <div id="pauseScreen" class="screen hidden">
    <h2 style="color:#00ff88">PAUSED</h2>
    <button class="btn" id="resumeBtn">RESUME</button>
    <button class="btn secondary" id="pauseMenuBtn">QUIT TO MENU</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    window.onload = function() {
      // ═══════════════════════════════════════════════════════════════
      // THREE.JS SETUP
      // ═══════════════════════════════════════════════════════════════
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 5000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      document.body.insertBefore(renderer.domElement, document.body.firstChild);

      // Lighting
      scene.add(new THREE.AmbientLight(0x222244, 0.3));
      const sun = new THREE.DirectionalLight(0xffffee, 1.2);
      sun.position.set(200, 100, 200);
      scene.add(sun);
      [{ c: 0x00ff88, p: [-80,40,-80] }, { c: 0xff0055, p: [80,-40,80] }, { c: 0x8800ff, p: [0,80,-150] }].forEach(l => {
        const light = new THREE.PointLight(l.c, 0.4, 250);
        light.position.set(...l.p);
        scene.add(light);
      });

      // ═══════════════════════════════════════════════════════════════
      // ENVIRONMENT
      // ═══════════════════════════════════════════════════════════════
      // Skybox
      scene.add(new THREE.Mesh(new THREE.SphereGeometry(2500,32,32), new THREE.MeshBasicMaterial({color:0x000008,side:THREE.BackSide})));

      // Stars
      const starsGeo = new THREE.BufferGeometry();
      const starCount = isMobile ? 3000 : 8000;
      const starPos = new Float32Array(starCount*3);
      const starCol = new Float32Array(starCount*3);
      for(let i=0;i<starCount;i++){
        const r=1800+Math.random()*600, t=Math.random()*Math.PI*2, p=Math.acos(2*Math.random()-1);
        starPos[i*3]=r*Math.sin(p)*Math.cos(t); starPos[i*3+1]=r*Math.sin(p)*Math.sin(t); starPos[i*3+2]=r*Math.cos(p);
        const c=Math.random(); starCol[i*3]=c<0.1?0.6:1; starCol[i*3+1]=c<0.1?0.8:(c<0.15?0.9:1); starCol[i*3+2]=1;
      }
      starsGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
      starsGeo.setAttribute('color', new THREE.BufferAttribute(starCol,3));
      scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({size:2,vertexColors:true})));

      // Nebulae
      const nebulaColors = [0x8800ff,0x00ff88,0xff0055,0x00aaff];
      for(let i=0;i<25;i++){
        const neb = new THREE.Mesh(
          new THREE.SphereGeometry(40+Math.random()*60,10,10),
          new THREE.MeshBasicMaterial({color:nebulaColors[i%4],transparent:true,opacity:0.02,side:THREE.DoubleSide})
        );
        const d=500+Math.random()*1000, t=Math.random()*Math.PI*2, p=Math.random()*Math.PI;
        neb.position.set(d*Math.sin(p)*Math.cos(t), d*Math.sin(p)*Math.sin(t)*0.4, d*Math.cos(p));
        scene.add(neb);
      }

      // Planet - much bigger and more dramatic
      const planet = new THREE.Group();
      planet.add(new THREE.Mesh(new THREE.SphereGeometry(250,48,48), new THREE.MeshPhongMaterial({color:0x2255aa,emissive:0x112244,shininess:20})));
      planet.add(new THREE.Mesh(new THREE.SphereGeometry(265,48,48), new THREE.MeshBasicMaterial({color:0x4488ff,transparent:true,opacity:0.12,side:THREE.BackSide})));
      const ring = new THREE.Mesh(new THREE.RingGeometry(320,450,64), new THREE.MeshBasicMaterial({color:0x886644,transparent:true,opacity:0.25,side:THREE.DoubleSide}));
      ring.rotation.x = Math.PI/2.3;
      planet.add(ring);
      const ring2 = new THREE.Mesh(new THREE.RingGeometry(290,310,64), new THREE.MeshBasicMaterial({color:0xaa8866,transparent:true,opacity:0.15,side:THREE.DoubleSide}));
      ring2.rotation.x = Math.PI/2.3;
      planet.add(ring2);
      planet.position.set(-600,-200,-1200);
      scene.add(planet);

      // Distant sun with glow
      const sunGroup = new THREE.Group();
      const sunCore = new THREE.Mesh(new THREE.SphereGeometry(60,32,32), new THREE.MeshBasicMaterial({color:0xffffcc}));
      sunGroup.add(sunCore);
      const sunGlow = new THREE.Mesh(new THREE.SphereGeometry(100,32,32), new THREE.MeshBasicMaterial({color:0xffaa44,transparent:true,opacity:0.15}));
      sunGroup.add(sunGlow);
      const sunFlare = new THREE.Mesh(new THREE.SphereGeometry(150,32,32), new THREE.MeshBasicMaterial({color:0xff8800,transparent:true,opacity:0.05}));
      sunGroup.add(sunFlare);
      sunGroup.position.set(800,400,1500);
      scene.add(sunGroup);

      // Allied fleet capital ships
      const fleetShips = [];
      function createFleetShip(name, pos, size) {
        const g = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(size*0.3,size*0.15,size), new THREE.MeshPhongMaterial({color:0x226644,emissive:0x112233}));
        g.add(body);
        const bridge = new THREE.Mesh(new THREE.BoxGeometry(size*0.12,size*0.12,size*0.15), new THREE.MeshPhongMaterial({color:0x338855}));
        bridge.position.set(0,size*0.1,size*0.2);
        g.add(bridge);
        // Engine glow
        for(let i=-1;i<=1;i++) {
          const eng = new THREE.Mesh(new THREE.SphereGeometry(size*0.04,8,8), new THREE.MeshBasicMaterial({color:0x00ffff,transparent:true,opacity:0.8}));
          eng.position.set(i*size*0.1,0,-size*0.52);
          g.add(eng);
        }
        g.position.copy(pos);
        scene.add(g);
        fleetShips.push({ mesh:g, name, health:500+size*50, maxHealth:500+size*50, position:pos.clone(), size });
        return g;
      }
      createFleetShip('CARRIER ATLAS', new THREE.Vector3(0,-30,-120), 30);
      createFleetShip('CRUISER TITAN', new THREE.Vector3(-60,-10,-100), 18);
      createFleetShip('DESTROYER NOVA', new THREE.Vector3(60,-20,-110), 14);

      // Asteroids
      const asteroids = [];
      const astGeos = [new THREE.DodecahedronGeometry(1,0), new THREE.IcosahedronGeometry(1,0)];
      for(let i=0;i<100;i++){
        const g = astGeos[i%2].clone();
        const pos = g.attributes.position;
        for(let j=0;j<pos.count;j++) pos.setXYZ(j, pos.getX(j)*(0.7+Math.random()*0.6), pos.getY(j)*(0.7+Math.random()*0.6), pos.getZ(j)*(0.7+Math.random()*0.6));
        g.computeVertexNormals();
        const ast = new THREE.Mesh(g, new THREE.MeshPhongMaterial({color:0x555555,flatShading:true}));
        ast.position.set((Math.random()-0.5)*400, (Math.random()-0.5)*200, (Math.random()-0.5)*400);
        const s = 2+Math.random()*5;
        ast.scale.set(s,s,s);
        ast.userData = { rotSpeed:{x:(Math.random()-0.5)*0.01,y:(Math.random()-0.5)*0.01}, size:s*1.5 };
        scene.add(ast);
        asteroids.push(ast);
      }

      // ═══════════════════════════════════════════════════════════════
      // SHIPS
      // ═══════════════════════════════════════════════════════════════
      const shipTypes = [
        { name:'VIPER', speed:2.2, health:80, shield:40, energy:100, fireRate:0.9, damage:1, desc:'Fast & agile', unlocked:true, cost:0 },
        { name:'TITAN', speed:1.5, health:150, shield:80, energy:80, fireRate:0.7, damage:1.3, desc:'Heavy tank', unlocked:false, cost:2000 },
        { name:'PHANTOM', speed:2.5, health:60, shield:30, energy:120, fireRate:1.2, damage:0.9, desc:'Speed demon', unlocked:false, cost:3000 },
        { name:'SENTINEL', speed:1.8, health:100, shield:100, energy:90, fireRate:0.8, damage:1.1, desc:'Balanced shields', unlocked:false, cost:5000 }
      ];
      let selectedShip = 0;
      let shipColor = 0x00ff88;

      function createShip(color = shipColor) {
        const ship = new THREE.Group();
        const bodyMat = new THREE.MeshPhongMaterial({color, emissive:new THREE.Color(color).multiplyScalar(0.2), shininess:100});
        const body = new THREE.Mesh(new THREE.ConeGeometry(1.2,5,8), bodyMat);
        body.rotation.x = Math.PI/2;
        ship.add(body);
        const cockpit = new THREE.Mesh(new THREE.SphereGeometry(0.6,16,16), new THREE.MeshPhongMaterial({color:0x00ddff,emissive:0x004466,transparent:true,opacity:0.9}));
        cockpit.position.z = 1;
        cockpit.scale.set(1,0.4,0.7);
        ship.add(cockpit);
        const wings = new THREE.Mesh(new THREE.BoxGeometry(7,0.12,1.8), new THREE.MeshPhongMaterial({color:new THREE.Color(color).multiplyScalar(0.7)}));
        wings.position.z = -0.3;
        ship.add(wings);
        [-3.5,3.5].forEach(x => {
          const tip = new THREE.Mesh(new THREE.ConeGeometry(0.2,0.7,6), new THREE.MeshPhongMaterial({color:0xff0055}));
          tip.position.set(x,0,-0.3);
          tip.rotation.z = x<0 ? Math.PI/2 : -Math.PI/2;
          ship.add(tip);
        });
        [-1.2,0,1.2].forEach((x,i) => {
          const eng = new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.45,0.8,8), new THREE.MeshPhongMaterial({color:0x333333}));
          eng.position.set(x,0,-2.2);
          eng.rotation.x = Math.PI/2;
          ship.add(eng);
          const glow = new THREE.Mesh(new THREE.ConeGeometry(0.35,1.5,8), new THREE.MeshBasicMaterial({color:0xff8800,transparent:true,opacity:0.7}));
          glow.position.set(x,0,-3);
          glow.rotation.x = -Math.PI/2;
          glow.name = 'glow'+i;
          ship.add(glow);
        });
        return ship;
      }

      const playerShip = createShip();
      scene.add(playerShip);

      // Smoke particles for damage
      let smokeParticles = [];

      // ═══════════════════════════════════════════════════════════════
      // GAME STATE
      // ═══════════════════════════════════════════════════════════════
      let gameRunning = false, gamePaused = false, gameMode = 'campaign';
      let score = 0, credits = 0, totalCredits = 0, kills = 0, level = 1, wave = 1, combo = 1, comboTimer = 0;
      let pilotXP = 0, pilotRank = 0;
      const ranks = ['ROOKIE','CADET','ENSIGN','LIEUTENANT','CAPTAIN','COMMANDER','ACE','ELITE','LEGEND'];

      const player = {
        position: new THREE.Vector3(0,0,0),
        velocity: new THREE.Vector3(0,0,0),
        rotation: new THREE.Euler(0,0,0,'YXZ'),
        quaternion: new THREE.Quaternion(),
        health: 100, maxHealth: 100,
        shield: 50, maxShield: 50,
        boost: 100, maxBoost: 100,
        energy: 100, maxEnergy: 100,
        speed: 0, maxSpeed: 2, boostSpeed: 4,
        rollAngle: 0
      };

      // First person view
      let firstPerson = false;

      // Weapons
      const weapons = [
        { name:'LASER', color:0x00ff88, damage:8, fireRate:80, energyCost:2, speed:4, spread:0, count:2, unlocked:true, charge:0, maxCharge:0 },
        { name:'PLASMA', color:0x00aaff, damage:18, fireRate:180, energyCost:6, speed:3.5, spread:0.04, count:2, unlocked:false, charge:0, maxCharge:0 },
        { name:'MISSILE', color:0xff8800, damage:45, fireRate:500, energyCost:20, speed:2.5, homing:true, count:1, unlocked:false, charge:0, maxCharge:0 },
        { name:'RAILGUN', color:0xff00ff, damage:120, fireRate:1200, energyCost:50, speed:10, pierce:true, count:1, unlocked:false, charge:0, maxCharge:100, needsCharge:true },
        { name:'SCATTER', color:0xffff00, damage:10, fireRate:300, energyCost:12, speed:4, spread:0.12, count:7, unlocked:false, charge:0, maxCharge:0 }
      ];
      let currentWeapon = 0, railgunCharging = false, railgunCharge = 0;

      // Wingmen
      const wingmen = [
        { name:'ALPHA', status:'active', health:100, maxHealth:100, position:new THREE.Vector3(-15,0,10), mesh:null },
        { name:'BRAVO', status:'active', health:100, maxHealth:100, position:new THREE.Vector3(15,0,10), mesh:null }
      ];

      // Mission system - 7 mission epic campaign
      const missions = [
        { type:'PATROL', name:'First Contact', objective:'Destroy 10 enemy scouts', target:10, reward:500 },
        { type:'PATROL', name:'Behind Enemy Lines', objective:'Destroy 20 fighters', target:20, reward:800 },
        { type:'ESCORT', name:'Protect the Convoy', objective:'Keep transport alive', target:1, reward:1000 },
        { type:'ASSAULT', name:'Carrier Assault', objective:'Destroy the enemy carrier', target:1, reward:1500 },
        { type:'PATROL', name:'Operation Eclipse', objective:'Destroy 30 elite hostiles', target:30, reward:2000 },
        { type:'BOSS', name:'Eliminate the Ace', objective:'Defeat enemy ace commander', target:1, reward:3000 },
        { type:'BOSS', name:'Final Stand', objective:'Destroy the enemy dreadnought', target:1, reward:5000 }
      ];
      let currentMission = 0, missionProgress = 0, missionComplete = false;

      // Escort target
      let escortTarget = null;

      // Capital ship
      let capitalShip = null;

      // Enemy aces
      const aceNames = ['CRIMSON SHADOW','IRON FIST','GHOST','VENOM','SPECTER'];
      let currentAce = null;

      // Arrays
      let bullets = [], enemies = [], enemyBullets = [], explosions = [], shockwaves = [], powerups = [], hitSparks = [], engineTrails = [];

      // Boss
      let boss = null, bossPhase = 1;

      // Lock-on
      let lockedTarget = null, lockProgress = 0;

      // Input
      const keys = {};
      let mouseDeltaX = 0, mouseDeltaY = 0, isPointerLocked = false, shooting = false, lastShot = 0;

      // Mobile detection
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || (navigator.maxTouchPoints > 1 && window.innerWidth < 1024);
      let touchThrust = false, touchBoosting = false, touchLocking = false;
      let joystickDX = 0, joystickDY = 0;

      // Settings
      let settings = {
        sensitivity: 5,
        volume: 50,
        voiceAlerts: true,
        music: true,
        graphics: 'medium',
        showFPS: false
      };

      // Statistics
      let stats = {
        totalKills: 0,
        totalDeaths: 0,
        totalCredits: 0,
        totalShots: 0,
        totalHits: 0,
        timePlayed: 0,
        bossesKilled: 0,
        highestCombo: 0,
        missionsCompleted: 0
      };

      // Tutorial
      const tutorialSteps = [
        { title:'FLIGHT CONTROLS', text:'Use your mouse to aim. Your ship follows your crosshair.', keys:'MOUSE = AIM' },
        { title:'MOVEMENT', text:'WASD to fly. W accelerates, S brakes, A/D strafe.', keys:'WASD = FLY' },
        { title:'COMBAT', text:'Click to fire. Hold Tab to lock onto enemies for homing missiles.', keys:'CLICK = FIRE | TAB = LOCK' },
        { title:'BOOST', text:'Hold Shift for speed boost. Use Q/E for barrel rolls.', keys:'SHIFT = BOOST | Q/E = ROLL' },
        { title:'WEAPONS', text:'Press 1-5 to switch weapons. Railgun needs charging - hold to charge!', keys:'1-5 = WEAPONS' },
        { title:'VIEWS', text:'Press V to toggle cockpit view for immersion.', keys:'V = TOGGLE VIEW' }
      ];
      let tutorialStep = 0;

      // Audio
      let audioCtx = null, muted = false, musicPlaying = false, musicInterval = null;

      // ═══════════════════════════════════════════════════════════════
      // AUDIO & VOICE
      // ═══════════════════════════════════════════════════════════════
      function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }

      function playSound(freq, type, dur, vol=0.15) {
        if(muted||!audioCtx) return;
        try {
          const o=audioCtx.createOscillator(), g=audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.frequency.value=freq; o.type=type;
          g.gain.setValueAtTime(vol*(settings.volume/100), audioCtx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+dur);
          o.start(); o.stop(audioCtx.currentTime+dur);
        } catch(e){}
      }

      function playShoot() {
        const w = weapons[currentWeapon];
        if(w.name==='LASER') playSound(800,'square',0.05,0.1);
        else if(w.name==='PLASMA') playSound(400,'sawtooth',0.1,0.12);
        else if(w.name==='MISSILE') playSound(200,'triangle',0.15,0.15);
        else if(w.name==='RAILGUN') playSound(100,'sawtooth',0.3,0.25);
        else playSound(600,'square',0.08,0.1);
      }
      function playHit() { playSound(300,'square',0.05,0.1); }
      function playExplosion(big=false) { playSound(big?60:100,'sawtooth',big?0.4:0.25,big?0.25:0.18); }

      function speak(text) {
        if(!settings.voiceAlerts) return;
        const el = document.getElementById('voiceText');
        el.textContent = text;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 2000);
        // Could use Web Speech API here for actual voice
      }

      function radioMessage(sender, text) {
        const container = document.getElementById('radioMessages');
        const msg = document.createElement('div');
        msg.className = 'radio-msg';
        msg.innerHTML = `<div class="sender">${sender}</div><div class="text">${text}</div>`;
        container.appendChild(msg);
        setTimeout(() => msg.remove(), 5000);
      }

      const musicNotes = [65.41,73.42,82.41,87.31,98.00,110.00,123.47,130.81];
      let noteIdx = 0;
      function startMusic() {
        if(musicPlaying||!settings.music||!audioCtx) return;
        musicPlaying = true;
        musicInterval = setInterval(() => {
          if(!gameRunning||gamePaused||!settings.music) return;
          playSound(musicNotes[noteIdx%8]*(noteIdx%16<8?1:0.5), 'triangle', 0.25, 0.025);
          noteIdx++;
        }, 200);
      }
      function stopMusic() { musicPlaying=false; if(musicInterval){clearInterval(musicInterval);musicInterval=null;} }

      // ═══════════════════════════════════════════════════════════════
      // OBJECT CREATION
      // ═══════════════════════════════════════════════════════════════
      function createBullet(pos, dir, wIdx, isEnemy=false) {
        const w = isEnemy ? {color:0xff0055,speed:1.5,damage:15} : weapons[wIdx];
        const size = isEnemy ? 0.25 : (w.name==='RAILGUN'?0.1:(w.name==='MISSILE'?0.35:0.15));
        let geo, mat;
        if(w.name==='RAILGUN') {
          geo = new THREE.CylinderGeometry(0.08,0.08,4,8);
          mat = new THREE.MeshBasicMaterial({color:w.color,transparent:true,opacity:0.9});
        } else {
          geo = new THREE.SphereGeometry(size,8,8);
          mat = new THREE.MeshBasicMaterial({color:isEnemy?0xff0055:w.color});
        }
        const bullet = new THREE.Mesh(geo, mat);
        bullet.position.copy(pos);
        if(w.name==='RAILGUN') bullet.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0), dir.clone().normalize());
        const glow = new THREE.Mesh(new THREE.SphereGeometry(size*2.5,8,8), new THREE.MeshBasicMaterial({color:isEnemy?0xff0055:w.color,transparent:true,opacity:0.2}));
        bullet.add(glow);
        scene.add(bullet);
        return { mesh:bullet, position:pos.clone(), velocity:dir.clone().multiplyScalar(isEnemy?1.5:w.speed), damage:isEnemy?15:w.damage, isEnemy, homing:w.homing||false, pierce:w.pierce||false, pierced:[], life:250, color:isEnemy?0xff0055:w.color };
      }

      function createEnemy(type, pos) {
        const group = new THREE.Group();
        let health, speed, points, size, shootInt;
        if(type==='fighter') { health=25;speed=0.9;points=100;size=2;shootInt=2500;
          group.add(new THREE.Mesh(new THREE.ConeGeometry(0.8,2.5,6), new THREE.MeshPhongMaterial({color:0xff0055})));
        } else if(type==='bomber') { health=70;speed=0.4;points=250;size=3.5;shootInt=1500;
          group.add(new THREE.Mesh(new THREE.SphereGeometry(1.5,8,8), new THREE.MeshPhongMaterial({color:0x8800ff})));
        } else if(type==='interceptor') { health=12;speed=1.5;points=120;size=1.5;shootInt=3000;
          group.add(new THREE.Mesh(new THREE.TetrahedronGeometry(1), new THREE.MeshPhongMaterial({color:0xffff00})));
        } else { health=20;speed=0.6;points=80;size=2;shootInt=3000;
          group.add(new THREE.Mesh(new THREE.ConeGeometry(1,2,5), new THREE.MeshPhongMaterial({color:0xff3366})));
        }
        group.position.copy(pos);
        scene.add(group);
        return { mesh:group, type, position:pos.clone(), velocity:new THREE.Vector3(), health:health*(1+level*0.1), maxHealth:health*(1+level*0.1), speed:speed*(1+level*0.02), points, size, shootTimer:Math.random()*shootInt, shootInterval:shootInt, behavior:Math.random() };
      }

      function createAce(pos) {
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.ConeGeometry(1.5,4,8), new THREE.MeshPhongMaterial({color:0xff0000,emissive:0x440000,shininess:100}));
        body.rotation.x = Math.PI/2;
        group.add(body);
        const wings = new THREE.Mesh(new THREE.BoxGeometry(6,0.15,2), new THREE.MeshPhongMaterial({color:0xaa0000}));
        group.add(wings);
        const aura = new THREE.Mesh(new THREE.SphereGeometry(3,16,16), new THREE.MeshBasicMaterial({color:0xff0000,transparent:true,opacity:0.1}));
        group.add(aura);
        group.position.copy(pos);
        scene.add(group);
        return { mesh:group, name:aceNames[Math.floor(Math.random()*aceNames.length)], position:pos.clone(), velocity:new THREE.Vector3(), health:300+level*50, maxHealth:300+level*50, speed:1.2, size:3, shootTimer:0, pattern:0, patternTimer:0, points:2000+level*500 };
      }

      function createBoss(pos) {
        const group = new THREE.Group();
        group.add(new THREE.Mesh(new THREE.DodecahedronGeometry(6), new THREE.MeshPhongMaterial({color:0xff0088,emissive:0x440022})));
        group.add(new THREE.Mesh(new THREE.SphereGeometry(2.5,16,16), new THREE.MeshBasicMaterial({color:0xffff00,transparent:true,opacity:0.8})));
        for(let i=0;i<3;i++){
          const ring = new THREE.Mesh(new THREE.TorusGeometry(8+i*2,0.4,8,32), new THREE.MeshPhongMaterial({color:0xff00ff}));
          ring.name = 'ring'+i;
          group.add(ring);
        }
        group.position.copy(pos);
        scene.add(group);
        const hp = 800+level*300;
        return { mesh:group, position:pos.clone(), health:hp, maxHealth:hp, size:12, shootTimer:0, patternTimer:0, pattern:0, phase:1, points:5000+level*1000, name:'DESTROYER MK-'+level };
      }

      function createCapitalShip(pos) {
        const group = new THREE.Group();
        // Main hull
        const hull = new THREE.Mesh(new THREE.BoxGeometry(40,10,15), new THREE.MeshPhongMaterial({color:0x444466}));
        group.add(hull);
        // Bridge
        const bridge = new THREE.Mesh(new THREE.BoxGeometry(8,5,8), new THREE.MeshPhongMaterial({color:0x666688}));
        bridge.position.set(0,7,0);
        bridge.userData.part = 'bridge';
        group.add(bridge);
        // Engines
        [-12,12].forEach(x => {
          const eng = new THREE.Mesh(new THREE.CylinderGeometry(3,4,8,8), new THREE.MeshPhongMaterial({color:0x333344}));
          eng.position.set(x,-2,-10);
          eng.rotation.x = Math.PI/2;
          eng.userData.part = 'engine';
          group.add(eng);
        });
        group.position.copy(pos);
        scene.add(group);
        return { mesh:group, position:pos.clone(), health:2000, maxHealth:2000, bridgeHealth:500, engineHealth:[300,300], size:25, shootTimer:0, points:10000 };
      }

      function createEscortTarget(pos) {
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(8,4,20), new THREE.MeshPhongMaterial({color:0x44aa44}));
        group.add(body);
        const eng = new THREE.Mesh(new THREE.CylinderGeometry(1.5,2,4,8), new THREE.MeshPhongMaterial({color:0x336633}));
        eng.position.z = -12;
        eng.rotation.x = Math.PI/2;
        group.add(eng);
        group.position.copy(pos);
        scene.add(group);
        return { mesh:group, position:pos.clone(), health:500, maxHealth:500, size:10 };
      }

      function createWingman(pos, color=0x00aa66) {
        const ship = createShip(color);
        ship.scale.set(0.8,0.8,0.8);
        ship.position.copy(pos);
        scene.add(ship);
        return ship;
      }

      function createExplosion(pos, color, size=1) {
        const group = new THREE.Group();
        group.position.copy(pos);
        group.add(new THREE.Mesh(new THREE.SphereGeometry(size*1.5,12,12), new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:1})));
        group.add(new THREE.Mesh(new THREE.SphereGeometry(size*2.5,12,12), new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.7})));
        for(let i=0;i<20;i++){
          const d = new THREE.Mesh(new THREE.BoxGeometry(size*0.2,size*0.2,size*0.2), new THREE.MeshBasicMaterial({color}));
          d.userData.vel = new THREE.Vector3((Math.random()-0.5)*3,(Math.random()-0.5)*3,(Math.random()-0.5)*3);
          group.add(d);
        }
        scene.add(group);
        return { mesh:group, life:40, maxLife:40 };
      }

      function createShockwave(pos, color, maxSize=15) {
        const ring = new THREE.Mesh(new THREE.RingGeometry(0.1,0.5,32), new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.8,side:THREE.DoubleSide}));
        ring.position.copy(pos);
        ring.lookAt(camera.position);
        scene.add(ring);
        return { mesh:ring, life:30, maxLife:30, maxSize };
      }

      function createHitSpark(pos, color) {
        const group = new THREE.Group();
        group.position.copy(pos);
        for(let i=0;i<8;i++){
          const spark = new THREE.Mesh(new THREE.SphereGeometry(0.1,4,4), new THREE.MeshBasicMaterial({color}));
          spark.userData.vel = new THREE.Vector3((Math.random()-0.5)*2,(Math.random()-0.5)*2,(Math.random()-0.5)*2);
          group.add(spark);
        }
        scene.add(group);
        return { mesh:group, life:15, maxLife:15 };
      }

      function createSmoke(pos) {
        const smoke = new THREE.Mesh(new THREE.SphereGeometry(0.3,6,6), new THREE.MeshBasicMaterial({color:0x444444,transparent:true,opacity:0.5}));
        smoke.position.copy(pos);
        scene.add(smoke);
        return { mesh:smoke, life:30, maxLife:30 };
      }

      function createPowerup(pos, type) {
        const colors = {health:0x00ff00,shield:0x00aaff,energy:0x8800ff,credits:0xffff00,weapon:0xff00ff};
        const group = new THREE.Group();
        group.add(new THREE.Mesh(new THREE.OctahedronGeometry(0.6), new THREE.MeshBasicMaterial({color:colors[type]||0xffffff})));
        group.add(new THREE.Mesh(new THREE.SphereGeometry(1,12,12), new THREE.MeshBasicMaterial({color:colors[type]||0xffffff,transparent:true,opacity:0.25})));
        group.position.copy(pos);
        scene.add(group);
        return { mesh:group, position:pos.clone(), type, life:500, color:colors[type] };
      }

      // ═══════════════════════════════════════════════════════════════
      // SPAWNING
      // ═══════════════════════════════════════════════════════════════
      function spawnEnemy() {
        const types = ['basic','fighter','interceptor','bomber'];
        const type = types[Math.floor(Math.random()*Math.min(types.length,2+Math.floor(level/2)))];
        const d=100+Math.random()*60, t=Math.random()*Math.PI*2, p=Math.random()*Math.PI*0.5+Math.PI*0.25;
        const pos = new THREE.Vector3(player.position.x+d*Math.sin(p)*Math.cos(t), player.position.y+d*Math.cos(p)*0.4, player.position.z+d*Math.sin(p)*Math.sin(t));
        enemies.push(createEnemy(type, pos));
      }

      function spawnBoss() {
        if(boss) return;
        speak('WARNING - BOSS APPROACHING');
        const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
        setTimeout(() => { if(!gameRunning) return; boss = createBoss(player.position.clone().add(fwd.multiplyScalar(80))); bossPhase = 1; document.getElementById('bossUI').style.display = 'flex'; document.getElementById('bossName').textContent = boss.name; }, 3000);
      }

      function spawnAce() {
        if(currentAce) return;
        speak('ENEMY ACE DETECTED');
        const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
        currentAce = createAce(player.position.clone().add(fwd.multiplyScalar(70)));
        radioMessage('COMMAND', 'Enemy ace detected. Eliminate with extreme prejudice.');
      }

      // ═══════════════════════════════════════════════════════════════
      // UI
      // ═══════════════════════════════════════════════════════════════
      function updateUI() {
        document.getElementById('score').textContent = score.toLocaleString();
        document.getElementById('level').textContent = level;
        document.getElementById('kills').textContent = kills;
        document.getElementById('wave').textContent = wave;
        document.getElementById('combo').textContent = combo;
        document.getElementById('credits').textContent = credits.toLocaleString();
        document.getElementById('rank').textContent = ranks[Math.min(pilotRank, ranks.length-1)];
        document.getElementById('healthBar').style.width = (player.health/player.maxHealth*100)+'%';
        document.getElementById('shieldBar').style.width = (player.shield/player.maxShield*100)+'%';
        document.getElementById('boostBar').style.width = (player.boost/player.maxBoost*100)+'%';
        document.getElementById('energyBar').style.width = (player.energy/player.maxEnergy*100)+'%';
        document.getElementById('speed').textContent = Math.floor(player.speed*100);
        document.getElementById('weaponName').textContent = weapons[currentWeapon].name;
        document.getElementById('weaponName').style.color = '#'+weapons[currentWeapon].color.toString(16).padStart(6,'0');
        document.getElementById('cockpitSpeed').textContent = Math.floor(player.speed*100);
        document.getElementById('cockpitWeapon').textContent = weapons[currentWeapon].name;
        // Mission
        const m = missions[currentMission%missions.length];
        document.getElementById('missionType').textContent = 'WAVE '+wave;
        document.getElementById('missionName').textContent = m.name;
        document.getElementById('missionObj').textContent = m.objective;
        document.getElementById('missionFill').style.width = Math.min(100, missionProgress/m.target*100)+'%';
        // Weapon slots
        renderWeaponSlots();
        // Low health effect
        document.getElementById('lowHealthOverlay').style.display = player.health < player.maxHealth*0.25 ? 'block' : 'none';
      }

      function renderWeaponSlots() {
        const container = document.getElementById('weaponSlots');
        container.innerHTML = '';
        weapons.forEach((w,i) => {
          const slot = document.createElement('div');
          slot.className = 'weapon-slot' + (i===currentWeapon?' active':'') + (w.unlocked?'':' locked');
          slot.innerHTML = `${w.name[0]}<span class="key">${i+1}</span>`;
          if(w.needsCharge) {
            const charge = document.createElement('div');
            charge.className = 'charge';
            charge.style.width = (railgunCharge/100*100)+'%';
            slot.appendChild(charge);
          }
          container.appendChild(slot);
        });
      }

      function renderWingmen() {
        const list = document.getElementById('wingmanList');
        list.innerHTML = '';
        wingmen.forEach(w => {
          const entry = document.createElement('div');
          entry.className = 'wingman-entry';
          entry.innerHTML = `<div class="wingman-icon${w.status==='dead'?' dead':''}">${w.name[0]}</div><div><div class="wingman-name">${w.name}</div><div class="wingman-status">${w.status==='dead'?'KIA':Math.floor(w.health)+'%'}</div></div>`;
          list.appendChild(entry);
        });
      }

      function updateRadar() {
        const canvas = document.getElementById('radarCanvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(0,20,10,0.4)';
        ctx.fillRect(0,0,150,150);
        ctx.strokeStyle = 'rgba(0,255,136,0.15)';
        ctx.beginPath(); ctx.arc(75,75,25,0,Math.PI*2); ctx.arc(75,75,50,0,Math.PI*2); ctx.stroke();
        const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
        const right = new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion);
        const up = new THREE.Vector3(0,1,0).applyQuaternion(player.quaternion);
        // Enemies
        enemies.forEach(e => {
          const rel = e.position.clone().sub(player.position);
          if(rel.length()>200) return;
          const x = rel.dot(right)*0.35, z = -rel.dot(fwd)*0.35;
          ctx.fillStyle = '#ff0055';
          ctx.beginPath(); ctx.arc(75+Math.max(-65,Math.min(65,x)),75+Math.max(-65,Math.min(65,z)),3,0,Math.PI*2); ctx.fill();
        });
        // Boss
        if(boss) {
          const rel = boss.position.clone().sub(player.position);
          ctx.fillStyle = '#ff00ff';
          ctx.beginPath(); ctx.arc(75+Math.max(-65,Math.min(65,rel.dot(right)*0.2)),75+Math.max(-65,Math.min(65,-rel.dot(fwd)*0.2)),6,0,Math.PI*2); ctx.fill();
        }
        // Wingmen
        wingmen.filter(w=>w.status==='active').forEach(w => {
          const rel = w.position.clone().sub(player.position);
          ctx.fillStyle = '#00ff88';
          ctx.beginPath(); ctx.arc(75+Math.max(-65,Math.min(65,rel.dot(right)*0.35)),75+Math.max(-65,Math.min(65,-rel.dot(fwd)*0.35)),3,0,Math.PI*2); ctx.fill();
        });
        // Player
        ctx.fillStyle = '#00ff88';
        ctx.beginPath(); ctx.moveTo(75,70); ctx.lineTo(79,80); ctx.lineTo(71,80); ctx.closePath(); ctx.fill();
      }

      function announce(text, color='#00ff88') {
        const el = document.getElementById('announcement');
        el.textContent = text;
        el.style.color = color;
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 2000);
      }

      // ═══════════════════════════════════════════════════════════════
      // LEGENDARY SYSTEMS
      // ═══════════════════════════════════════════════════════════════
      // Hyperspace jump effect
      let hyperspaceActive = false;
      let hyperspaceLines = [];
      function triggerHyperspace() {
        hyperspaceActive = true;
        hyperspaceLines = [];
        const hyperCount = isMobile ? 80 : 200;
        for(let i=0;i<hyperCount;i++){
          const geo = new THREE.BufferGeometry();
          const startPos = new THREE.Vector3((Math.random()-0.5)*100, (Math.random()-0.5)*100, -50-Math.random()*200);
          const endPos = startPos.clone().add(new THREE.Vector3(0,0,-50-Math.random()*100));
          geo.setFromPoints([startPos, endPos]);
          const line = new THREE.Line(geo, new THREE.LineBasicMaterial({color:0x00ffff,transparent:true,opacity:0.8}));
          scene.add(line);
          hyperspaceLines.push({mesh:line, speed:2+Math.random()*5, life:120});
        }
        playSound(80,'sine',2,0.3);
        announce('HYPERSPACE JUMP', '#00ffff');
        setTimeout(() => {
          hyperspaceActive = false;
          hyperspaceLines.forEach(l => scene.remove(l.mesh));
          hyperspaceLines = [];
          announce('SECTOR REACHED', '#00ff88');
        }, 3000);
      }

      // Combo rank milestones
      function checkComboMilestone() {
        if(combo === 10) announce('C RANK!', '#ffff00');
        else if(combo === 25) announce('B RANK - IMPRESSIVE!', '#ffaa00');
        else if(combo === 50) { announce('A RANK - ACE!', '#ff8800'); radioMessage('ATLAS','Outstanding piloting!'); }
        else if(combo === 100) { announce('S RANK - LEGENDARY!', '#ff0055'); radioMessage('ATLAS','You are a legend, Commander!'); }
        else if(combo === 200) { announce('SS RANK - GODLIKE!', '#ff00ff'); radioMessage('ATLAS','Impossible... You\'re unstoppable!'); }
      }

      // Boss warning
      function triggerBossWarning() {
        announce('⚠ WARNING - BOSS INCOMING ⚠', '#ff0000');
        playSound(500,'square',0.15,0.2);
        setTimeout(() => playSound(500,'square',0.15,0.2), 300);
        setTimeout(() => playSound(500,'square',0.15,0.2), 600);
        document.getElementById('damageOverlay').style.opacity = '0.3';
        document.getElementById('damageOverlay').style.background = 'radial-gradient(ellipse at center, transparent 40%, rgba(255,0,0,0.4) 100%)';
        setTimeout(() => {
          document.getElementById('damageOverlay').style.opacity = '0';
          document.getElementById('damageOverlay').style.background = '';
        }, 3000);
      }

      // Kill streak announcements
      let lastKillStreakAnnounce = 0;
      function checkKillStreak() {
        if(kills > 0 && kills % 25 === 0 && kills !== lastKillStreakAnnounce) {
          lastKillStreakAnnounce = kills;
          if(kills === 25) announce('25 KILLS - RAMPAGE!', '#ffaa00');
          else if(kills === 50) announce('50 KILLS - UNSTOPPABLE!', '#ff8800');
          else if(kills === 100) announce('100 KILLS - GODLIKE!', '#ff0055');
          else if(kills === 200) announce('200 KILLS - BEYOND LEGEND!', '#ff00ff');
          else announce(kills + ' KILLS!', '#ffff00');
          radioMessage('ATLAS', 'Command is impressed, pilot. ' + kills + ' confirmed kills.');
        }
      }

      // Ambient radio chatter
      let lastChatterTime = 0;
      const chatterLines = [
        ['ALPHA', 'Multiple contacts on my scope.'],
        ['BRAVO', 'Copy that, weapons are hot.'],
        ['ATLAS', 'Stay sharp out there, pilots.'],
        ['ALPHA', 'I\'ve got your six, Lead.'],
        ['BRAVO', 'Breaking right, engaging targets!'],
        ['ATLAS', 'Fleet shields are holding steady.'],
        ['ALPHA', 'These hostiles are everywhere!'],
        ['BRAVO', 'Good shooting, Lead!'],
        ['ATLAS', 'Reinforcements standing by if needed.'],
        ['ALPHA', 'Scanning for more hostiles...'],
        ['BRAVO', 'Enemy formation breaking apart!'],
        ['ATLAS', 'You\'re doing outstanding work out there.']
      ];

      function ambientChatter() {
        if(Date.now() - lastChatterTime < 15000) return;
        if(enemies.length < 2) return;
        lastChatterTime = Date.now();
        const line = chatterLines[Math.floor(Math.random()*chatterLines.length)];
        radioMessage(line[0], line[1]);
      }

      // ═══════════════════════════════════════════════════════════════
      // MAIN UPDATE
      // ═══════════════════════════════════════════════════════════════
      function update(dt) {
        if(!gameRunning || gamePaused) return;
        const delta = dt/16.67;
        stats.timePlayed += dt/1000;

        // Combo
        if(comboTimer > 0) { comboTimer -= dt; if(comboTimer <= 0) combo = 1; }

        // Player rotation
        if(isMobile) {
          const mobileSens = settings.sensitivity * 0.0015;
          player.rotation.y -= joystickDX * mobileSens * delta;
          player.rotation.x -= joystickDY * mobileSens * delta;
        } else {
          const sens = settings.sensitivity * 0.0004;
          player.rotation.y -= mouseDeltaX * sens;
          player.rotation.x -= mouseDeltaY * sens;
          mouseDeltaX = 0; mouseDeltaY = 0;
        }
        player.rotation.x = Math.max(-Math.PI/2+0.1, Math.min(Math.PI/2-0.1, player.rotation.x));

        if(keys['q']||keys['Q']) player.rollAngle += 0.04*delta;
        if(keys['e']||keys['E']) player.rollAngle -= 0.04*delta;
        player.rollAngle *= 0.93;

        player.quaternion.setFromEuler(player.rotation);
        player.quaternion.multiply(new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1), player.rollAngle));

        // Movement
        const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
        const right = new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion);
        let targetSpeed = 0, boosting = false;
        if(keys['w']||keys['W']) targetSpeed = player.maxSpeed;
        if(keys['s']||keys['S']) targetSpeed = -player.maxSpeed*0.4;
        if(keys['Shift'] && player.boost > 0 && targetSpeed > 0) { targetSpeed = player.boostSpeed; player.boost -= 0.4*delta; boosting = true; }
        else if(player.boost < player.maxBoost) player.boost += 0.15*delta;
        if(keys[' ']) player.velocity.multiplyScalar(0.92);
        player.speed += (targetSpeed - player.speed) * 0.05 * delta;
        player.velocity.copy(fwd).multiplyScalar(player.speed);
        if(keys['a']||keys['A']) player.velocity.add(right.clone().multiplyScalar(-0.4*delta));
        if(keys['d']||keys['D']) player.velocity.add(right.clone().multiplyScalar(0.4*delta));
        player.position.add(player.velocity.clone().multiplyScalar(delta));

        // Ship
        playerShip.position.copy(player.position);
        playerShip.quaternion.copy(player.quaternion);
        playerShip.children.forEach(c => { if(c.name&&c.name.includes('glow')) { c.scale.z = 0.6+player.speed*0.3+(boosting?0.8:0)+Math.random()*0.2; c.material.color.setHex(boosting?0x00ffff:0xff8800); }});

        // Smoke when damaged
        if(player.health < player.maxHealth*0.4 && Math.random() < 0.1) {
          smokeParticles.push(createSmoke(player.position.clone().add(new THREE.Vector3((Math.random()-0.5)*2,(Math.random()-0.5)*2,2))));
        }

        // Camera
        if(firstPerson) {
          camera.position.copy(player.position).add(fwd.clone().multiplyScalar(2));
          camera.quaternion.copy(player.quaternion);
          document.getElementById('cockpitHUD').style.display = 'block';
        } else {
          const camTarget = player.position.clone().add(fwd.clone().multiplyScalar(-10)).add(new THREE.Vector3(0,2.5,0));
          camera.position.lerp(camTarget, 0.08);
          camera.lookAt(player.position.clone().add(fwd.clone().multiplyScalar(15)));
          document.getElementById('cockpitHUD').style.display = 'none';
        }

        document.getElementById('boostOverlay').style.opacity = boosting ? 0.3 : (player.speed > 1.5 ? 0.1 : 0);

        // Railgun charging
        if(weapons[currentWeapon].needsCharge && shooting) {
          railgunCharging = true;
          railgunCharge = Math.min(100, railgunCharge + 1.5*delta);
        } else if(railgunCharging && railgunCharge >= 100) {
          // Fire charged shot
          railgunCharging = false;
          if(player.energy >= weapons[currentWeapon].energyCost) {
            player.energy -= weapons[currentWeapon].energyCost;
            playShoot();
            stats.totalShots++;
            bullets.push(createBullet(player.position.clone().add(fwd.clone().multiplyScalar(4)), fwd.clone(), currentWeapon));
          }
          railgunCharge = 0;
        } else if(!shooting) {
          railgunCharge *= 0.95;
          if(railgunCharge < 5) railgunCharge = 0;
        }

        // Regular shooting
        if(shooting && !weapons[currentWeapon].needsCharge && player.energy >= weapons[currentWeapon].energyCost) {
          const w = weapons[currentWeapon];
          if(Date.now() - lastShot > w.fireRate) {
            lastShot = Date.now();
            player.energy -= w.energyCost;
            playShoot();
            stats.totalShots++;
            for(let i=0;i<w.count;i++){
              const spread = (Math.random()-0.5)*(w.spread||0);
              const dir = fwd.clone();
              dir.x += spread; dir.y += (Math.random()-0.5)*(w.spread||0);
              dir.normalize();
              const offset = (i-(w.count-1)/2)*0.4;
              bullets.push(createBullet(player.position.clone().add(fwd.clone().multiplyScalar(4)).add(right.clone().multiplyScalar(offset)), dir, currentWeapon));
            }
          }
        }

        // Energy regen
        if(player.energy < player.maxEnergy) player.energy = Math.min(player.maxEnergy, player.energy + 0.15*delta);

        // Lock-on
        if(keys['Tab']) {
          let closest = null, closestScore = Infinity;
          [...enemies, boss, currentAce].filter(Boolean).forEach(e => {
            const toE = e.position.clone().sub(player.position);
            const dist = toE.length();
            const dot = toE.normalize().dot(fwd);
            if(dot > 0.7 && dist < 200) {
              const score = dist * (1-dot);
              if(score < closestScore) { closestScore = score; closest = e; }
            }
          });
          if(closest !== lockedTarget) { lockProgress = 0; lockedTarget = closest; }
          else if(closest) lockProgress = Math.min(1, lockProgress + 0.02*delta);
        } else {
          lockProgress *= 0.95;
          if(lockProgress < 0.1) { lockedTarget = null; lockProgress = 0; }
        }
        document.getElementById('lockIndicator').className = lockedTarget ? (lockProgress >= 1 ? 'locked' : 'locking') : '';
        document.getElementById('cockpitTarget').textContent = lockedTarget ? (lockedTarget.name || lockedTarget.type || 'ENEMY') : '---';

        // Target panel
        if(lockedTarget) {
          document.getElementById('targetPanel').style.display = 'block';
          document.getElementById('targetName').textContent = lockedTarget.name || lockedTarget.type || 'ENEMY';
          document.getElementById('targetHealth').style.width = (lockedTarget.health/lockedTarget.maxHealth*100)+'%';
          document.getElementById('targetDist').textContent = Math.floor(lockedTarget.position.distanceTo(player.position))+'m';
        } else {
          document.getElementById('targetPanel').style.display = 'none';
        }

        // Update bullets
        for(let i=bullets.length-1;i>=0;i--){
          const b = bullets[i];
          if(b.homing && lockedTarget && lockProgress >= 1) {
            const toT = lockedTarget.position.clone().sub(b.position).normalize();
            b.velocity.lerp(toT.multiplyScalar(b.velocity.length()), 0.05);
          }
          b.position.add(b.velocity.clone().multiplyScalar(delta));
          b.mesh.position.copy(b.position);
          b.life -= delta;
          if(b.life <= 0 || b.position.distanceTo(player.position) > 350) { scene.remove(b.mesh); bullets.splice(i,1); continue; }

          if(!b.isEnemy) {
            // Hit enemies
            for(let j=enemies.length-1;j>=0;j--){
              if(b.position.distanceTo(enemies[j].position) < enemies[j].size) {
                enemies[j].health -= b.damage;
                playHit();
                stats.totalHits++;
                hitSparks.push(createHitSpark(b.position.clone(), b.color));
                if(!b.pierce || b.pierced.includes(j)) { scene.remove(b.mesh); bullets.splice(i,1); }
                else b.pierced.push(j);
                if(enemies[j].health <= 0) {
                  score += enemies[j].points * combo;
                  credits += Math.floor(enemies[j].points/5);
                  kills++;
                  stats.totalKills++;
                  combo++;
                  comboTimer = 4000;
                  if(combo > stats.highestCombo) stats.highestCombo = combo;
                  checkComboMilestone();
                  checkKillStreak();
                  missionProgress++;
                  explosions.push(createExplosion(enemies[j].position, 0xff0055, enemies[j].size/2));
                  shockwaves.push(createShockwave(enemies[j].position, 0xff0055, enemies[j].size*3));
                  playExplosion();
                  if(Math.random() < 0.15) powerups.push(createPowerup(enemies[j].position, ['credits','credits','health','shield','energy'][Math.floor(Math.random()*5)]));
                  if(lockedTarget === enemies[j]) lockedTarget = null;
                  scene.remove(enemies[j].mesh);
                  enemies.splice(j,1);
                }
                break;
              }
            }
            // Hit boss
            if(boss && b.position.distanceTo(boss.position) < boss.size) {
              boss.health -= b.damage;
              playHit();
              stats.totalHits++;
              hitSparks.push(createHitSpark(b.position.clone(), b.color));
              scene.remove(b.mesh); bullets.splice(i,1);
              document.getElementById('bossHealthBar').style.width = (boss.health/boss.maxHealth*100)+'%';
              if(boss.health/boss.maxHealth < 0.66 && bossPhase === 1) { bossPhase = 2; document.getElementById('bossPhase').textContent = 'PHASE 2'; speak('BOSS PHASE 2'); }
              if(boss.health/boss.maxHealth < 0.33 && bossPhase === 2) { bossPhase = 3; document.getElementById('bossPhase').textContent = 'PHASE 3 - ENRAGED'; speak('BOSS ENRAGED'); }
              if(boss.health <= 0) {
                score += boss.points;
                credits += Math.floor(boss.points/3);
                kills++;
                stats.totalKills++;
                stats.bossesKilled++;
                missionProgress++;
                for(let k=0;k<6;k++) setTimeout(() => { if(boss) explosions.push(createExplosion(boss.position.clone().add(new THREE.Vector3((Math.random()-0.5)*15,(Math.random()-0.5)*15,(Math.random()-0.5)*15)), 0xff00ff, 4)); }, k*150);
                playExplosion(true);
                speak('BOSS DESTROYED');
                scene.remove(boss.mesh);
                boss = null;
                lockedTarget = null;
                document.getElementById('bossUI').style.display = 'none';
                level++;
                wave++;
              }
            }
            // Hit ace
            if(currentAce && b.position.distanceTo(currentAce.position) < currentAce.size) {
              currentAce.health -= b.damage;
              playHit();
              hitSparks.push(createHitSpark(b.position.clone(), b.color));
              scene.remove(b.mesh); bullets.splice(i,1);
              if(currentAce.health <= 0) {
                score += currentAce.points;
                credits += Math.floor(currentAce.points/3);
                kills++;
                stats.totalKills++;
                missionProgress++;
                explosions.push(createExplosion(currentAce.position, 0xff0000, 3));
                playExplosion(true);
                speak(currentAce.name + ' ELIMINATED');
                radioMessage('COMMAND', 'Excellent work, pilot. Ace eliminated.');
                scene.remove(currentAce.mesh);
                currentAce = null;
                lockedTarget = null;
              }
            }
          }
        }

        // Spawn enemies - more aggressive waves
        if(gameMode !== 'bossRush' && !boss && !currentAce && !hyperspaceActive) {
          if(Math.random() < (0.005+level*0.0015)*delta && enemies.length < 12+level*3) spawnEnemy();

          // Wave spawning - groups every 30 seconds
          if(Math.floor(stats.timePlayed) % 30 === 0 && Math.floor(stats.timePlayed) > 0 && Math.random() < 0.01) {
            radioMessage('ALPHA', 'Incoming wave! Multiple contacts!');
            for(let i=0; i<3+level; i++) setTimeout(() => spawnEnemy(), i*400);
          }
        }

        // Wave progression
        const m = missions[currentMission % missions.length];
        if(missionProgress >= m.target && !missionComplete) {
          missionComplete = true;
          credits += m.reward;
          pilotXP += m.reward;
          stats.missionsCompleted++;

          // Flawless bonus
          if(player.health >= player.maxHealth) {
            credits += 500;
            announce('FLAWLESS BONUS +500', '#ffff00');
          } else {
            announce('OBJECTIVE COMPLETE', '#00ff88');
          }

          radioMessage('COMMAND', 'Outstanding work, pilot. Preparing jump to next sector.');

          // Hyperspace transition
          setTimeout(() => triggerHyperspace(), 1500);

          setTimeout(() => {
            missionComplete = false;
            missionProgress = 0;
            currentMission++;
            wave++;

            // Check if all missions complete (campaign victory)
            if(currentMission >= missions.length && gameMode === 'campaign') {
              announce('CAMPAIGN VICTORY!', '#00ff88');
              radioMessage('COMMAND', 'All objectives secured. Welcome home, pilot.');
              setTimeout(() => showVictoryScreen(), 2000);
              return;
            }

            // Restore some resources between missions
            player.health = Math.min(player.maxHealth, player.health + 25);
            player.shield = player.maxShield;
            player.energy = player.maxEnergy;

            if(wave % 5 === 0) { triggerBossWarning(); setTimeout(() => spawnBoss(), 3000); }
            else if(wave % 3 === 0 && gameMode === 'campaign') { triggerBossWarning(); setTimeout(() => spawnAce(), 2000); }

            radioMessage('ATLAS', 'New sector reached. Sensors detecting hostiles.');
          }, 5000);
        }

        // Update enemies
        for(let i=enemies.length-1;i>=0;i--){
          const e = enemies[i];
          const toP = player.position.clone().sub(e.position);
          const dist = toP.length();
          const dir = toP.normalize();
          e.velocity.lerp(dir.multiplyScalar(e.speed), 0.02);
          e.position.add(e.velocity.clone().multiplyScalar(delta));
          e.mesh.position.copy(e.position);
          e.mesh.lookAt(player.position);
          e.shootTimer -= dt;
          if(e.shootTimer <= 0 && dist < 100) {
            e.shootTimer = e.shootInterval;
            enemyBullets.push(createBullet(e.position.clone(), player.position.clone().sub(e.position).normalize(), 0, true));
          }
          if(e.position.distanceTo(player.position) < e.size + 2.5) {
            takeDamage(20);
            explosions.push(createExplosion(e.position, 0xff0055, 1));
            playExplosion();
            scene.remove(e.mesh);
            enemies.splice(i,1);
            if(lockedTarget === e) lockedTarget = null;
          }
          if(dist > 300) { scene.remove(e.mesh); enemies.splice(i,1); if(lockedTarget === e) lockedTarget = null; }
        }

        // Update boss
        if(boss) {
          boss.patternTimer += dt;
          if(boss.patternTimer > 5000/bossPhase) { boss.patternTimer = 0; boss.pattern = (boss.pattern+1)%3; }
          const toP = player.position.clone().sub(boss.position).normalize();
          if(boss.pattern === 0) boss.position.lerp(player.position.clone().add(new THREE.Vector3(Math.cos(Date.now()*0.0004*bossPhase)*60,0,Math.sin(Date.now()*0.0004*bossPhase)*60)), 0.01);
          else if(boss.pattern === 1) boss.position.add(toP.clone().multiplyScalar(0.3*bossPhase*delta));
          boss.mesh.position.copy(boss.position);
          boss.mesh.lookAt(player.position);
          boss.mesh.children.forEach((c,idx) => { if(c.name&&c.name.includes('ring')) { c.rotation.x += 0.015*(idx+1)*bossPhase*delta; c.rotation.y += 0.01*(idx+1)*bossPhase*delta; }});
          boss.shootTimer -= dt;
          if(boss.shootTimer <= 0) {
            boss.shootTimer = 700/bossPhase;
            for(let i=0;i<4+bossPhase*2;i++){
              const angle = (i/(4+bossPhase*2))*Math.PI*2 + Date.now()*0.001;
              enemyBullets.push(createBullet(boss.position.clone(), new THREE.Vector3(Math.cos(angle)*0.3+toP.x,Math.sin(angle)*0.3+toP.y,toP.z).normalize(), 0, true));
            }
          }
        }

        // Update ace
        if(currentAce) {
          currentAce.patternTimer += dt;
          if(currentAce.patternTimer > 3000) { currentAce.patternTimer = 0; currentAce.pattern = (currentAce.pattern+1)%4; }
          const toP = player.position.clone().sub(currentAce.position).normalize();
          if(currentAce.pattern === 0) currentAce.velocity.lerp(toP.clone().multiplyScalar(currentAce.speed*1.5), 0.03);
          else if(currentAce.pattern === 1) currentAce.velocity.lerp(toP.clone().add(new THREE.Vector3(-toP.z,0,toP.x)).normalize().multiplyScalar(currentAce.speed), 0.03);
          else if(currentAce.pattern === 2) currentAce.velocity.lerp(toP.clone().multiplyScalar(-currentAce.speed), 0.03);
          else currentAce.velocity.multiplyScalar(0.95);
          currentAce.position.add(currentAce.velocity.clone().multiplyScalar(delta));
          currentAce.mesh.position.copy(currentAce.position);
          currentAce.mesh.lookAt(player.position);
          currentAce.shootTimer -= dt;
          if(currentAce.shootTimer <= 0) {
            currentAce.shootTimer = 400;
            enemyBullets.push(createBullet(currentAce.position.clone(), toP.clone(), 0, true));
            if(Math.random() < 0.3) enemyBullets.push(createBullet(currentAce.position.clone(), toP.clone().add(new THREE.Vector3((Math.random()-0.5)*0.2,(Math.random()-0.5)*0.2,0)).normalize(), 0, true));
          }
        }

        // Update enemy bullets
        for(let i=enemyBullets.length-1;i>=0;i--){
          const b = enemyBullets[i];
          b.position.add(b.velocity.clone().multiplyScalar(delta));
          b.mesh.position.copy(b.position);
          b.life -= delta;
          if(b.life <= 0) { scene.remove(b.mesh); enemyBullets.splice(i,1); continue; }
          if(b.position.distanceTo(player.position) < 2) { takeDamage(b.damage); scene.remove(b.mesh); enemyBullets.splice(i,1); }
        }

        // Update wingmen
        wingmen.filter(w=>w.status==='active').forEach(w => {
          const targetPos = player.position.clone().add(new THREE.Vector3(w.name==='ALPHA'?-15:15,0,10).applyQuaternion(player.quaternion));
          w.position.lerp(targetPos, 0.02);
          if(w.mesh) {
            w.mesh.position.copy(w.position);
            w.mesh.lookAt(player.position.clone().add(fwd.clone().multiplyScalar(20)));
          }
          // Wingmen shoot at enemies
          if(enemies.length > 0 && Math.random() < 0.01*delta) {
            const target = enemies[Math.floor(Math.random()*enemies.length)];
            bullets.push(createBullet(w.position.clone(), target.position.clone().sub(w.position).normalize(), 0));
          }
          // Random radio chatter
          if(Math.random() < 0.0001*delta) {
            const phrases = ['Got one!', 'Engaging target', 'Watch your six!', 'Nice shot!', 'On your wing'];
            radioMessage(w.name, phrases[Math.floor(Math.random()*phrases.length)]);
          }
        });

        // Update explosions
        for(let i=explosions.length-1;i>=0;i--){
          const exp = explosions[i];
          exp.life--;
          const prog = 1-exp.life/exp.maxLife;
          exp.mesh.scale.setScalar(1+prog*2.5);
          exp.mesh.children.forEach((c,idx) => {
            if(c.material) c.material.opacity = exp.life/exp.maxLife;
            if(idx >= 2 && c.userData.vel) { c.position.add(c.userData.vel); c.userData.vel.multiplyScalar(0.96); }
          });
          if(exp.life <= 0) { scene.remove(exp.mesh); explosions.splice(i,1); }
        }

        // Update shockwaves
        for(let i=shockwaves.length-1;i>=0;i--){
          const sw = shockwaves[i];
          sw.life--;
          const prog = 1-sw.life/sw.maxLife;
          sw.mesh.scale.setScalar(sw.maxSize*prog);
          sw.mesh.material.opacity = (1-prog)*0.6;
          sw.mesh.lookAt(camera.position);
          if(sw.life <= 0) { scene.remove(sw.mesh); shockwaves.splice(i,1); }
        }

        // Update hit sparks
        for(let i=hitSparks.length-1;i>=0;i--){
          const hs = hitSparks[i];
          hs.life--;
          hs.mesh.children.forEach(c => { c.position.add(c.userData.vel); c.material.opacity = hs.life/hs.maxLife; });
          if(hs.life <= 0) { scene.remove(hs.mesh); hitSparks.splice(i,1); }
        }

        // Update smoke
        for(let i=smokeParticles.length-1;i>=0;i--){
          const s = smokeParticles[i];
          s.life--;
          s.mesh.material.opacity = s.life/s.maxLife*0.5;
          s.mesh.scale.setScalar(1+(1-s.life/s.maxLife)*2);
          if(s.life <= 0) { scene.remove(s.mesh); smokeParticles.splice(i,1); }
        }

        // Update powerups
        for(let i=powerups.length-1;i>=0;i--){
          const p = powerups[i];
          p.life--;
          p.mesh.position.y = p.position.y + Math.sin(Date.now()*0.003)*0.5;
          p.mesh.rotation.y += 0.02*delta;
          const dist = p.position.distanceTo(player.position);
          if(dist < 25) { p.position.lerp(player.position, 0.05*delta); p.mesh.position.x = p.position.x; p.mesh.position.z = p.position.z; }
          if(dist < 4) {
            if(p.type==='health') { player.health = Math.min(player.maxHealth, player.health+30); speak('HULL REPAIRED'); }
            else if(p.type==='shield') { player.shield = Math.min(player.maxShield, player.shield+25); speak('SHIELDS RESTORED'); }
            else if(p.type==='energy') { player.energy = player.maxEnergy; speak('ENERGY RECHARGED'); }
            else if(p.type==='credits') { const amt = 50+level*10; credits += amt; speak('CREDITS ACQUIRED'); }
            scene.remove(p.mesh); powerups.splice(i,1); continue;
          }
          if(p.life <= 0) { scene.remove(p.mesh); powerups.splice(i,1); }
        }

        // Update asteroids
        asteroids.forEach(ast => {
          ast.rotation.x += ast.userData.rotSpeed.x*delta;
          ast.rotation.y += ast.userData.rotSpeed.y*delta;
          const dist = ast.position.distanceTo(player.position);
          if(dist > 300) ast.position.add(player.position.clone().sub(ast.position).normalize().multiplyScalar(dist-250));
          if(dist < ast.userData.size+2.5) { takeDamage(15); explosions.push(createExplosion(player.position, 0x888888, 0.5)); }
        });

        // Shield regen
        if(player.shield < player.maxShield) player.shield += 0.015*delta;

        // Rank progression
        const xpNeeded = (pilotRank+1)*1000;
        if(pilotXP >= xpNeeded && pilotRank < ranks.length-1) {
          pilotRank++;
          announce('RANK UP: '+ranks[pilotRank], '#00aaff');
          speak('PROMOTED TO '+ranks[pilotRank]);
        }

        // Legendary systems
        ambientChatter();
        planet.rotation.y += 0.0003;
        sunGlow.scale.setScalar(1 + Math.sin(Date.now()*0.002)*0.05);
        sunFlare.scale.setScalar(1 + Math.sin(Date.now()*0.001)*0.1);

        // Update hyperspace lines
        hyperspaceLines.forEach(l => {
          l.mesh.position.z += l.speed;
          l.life--;
        });

        // Fleet ships slowly drift
        fleetShips.forEach((f,i) => {
          f.mesh.position.y += Math.sin(Date.now()*0.0005+i)*0.01;
        });

        // Damage chatter from wingmen
        if(player.health < 30 && Math.random() < 0.002) {
          const urgentLines = [
            ['ALPHA','Lead, you\'re hit bad! Fall back!'],
            ['BRAVO','Watch it Commander, hull critical!'],
            ['ALPHA','I\'ll draw their fire! Get to safety!'],
            ['BRAVO','Lead is taking heavy damage!']
          ];
          const line = urgentLines[Math.floor(Math.random()*urgentLines.length)];
          radioMessage(line[0], line[1]);
        }

        updateUI();
        renderWingmen();
        updateRadar();
      }

      function takeDamage(amount) {
        if(player.shield > 0) {
          const shieldDmg = Math.min(player.shield, amount*0.7);
          player.shield -= shieldDmg;
          amount -= shieldDmg;
          document.getElementById('shieldOverlay').style.opacity = 0.4;
          setTimeout(() => document.getElementById('shieldOverlay').style.opacity = 0, 150);
        }
        player.health -= amount;
        playHit();
        document.getElementById('damageOverlay').style.opacity = 0.5;
        setTimeout(() => document.getElementById('damageOverlay').style.opacity = 0, 200);
        if(player.health <= player.maxHealth*0.3 && player.health > 0) speak('WARNING - HULL CRITICAL');
        if(player.health <= 0) endGame();
        updateUI();
      }

      // ═══════════════════════════════════════════════════════════════
      // GAME CONTROL
      // ═══════════════════════════════════════════════════════════════
      function startGame(mode) {
        gameMode = mode;
        hideAllScreens();
        resetGame();
        gameRunning = true;
        if(isMobile) {
          isPointerLocked = true; // Simulate for mobile
          document.getElementById('mobileControls').classList.add('active');
        } else {
          renderer.domElement.requestPointerLock();
        }
        startMusic();
        speak('LAUNCHING');
        if(mode === 'bossRush') { setTimeout(spawnBoss, 2000); }
      }

      function resetGame() {
        score = 0; kills = 0; level = 1; wave = 1; combo = 1; comboTimer = 0;
        currentMission = 0; missionProgress = 0; missionComplete = false;
        railgunCharge = 0; railgunCharging = false;
        bossPhase = 1;

        const ship = shipTypes[selectedShip];
        player.maxHealth = ship.health; player.health = ship.health;
        player.maxShield = ship.shield; player.shield = ship.shield;
        player.maxEnergy = ship.energy; player.energy = ship.energy;
        player.maxSpeed = ship.speed; player.boostSpeed = ship.speed*2;
        player.position.set(0,0,0);
        player.velocity.set(0,0,0);
        player.rotation.set(0,0,0);
        player.quaternion.identity();
        player.speed = 0;
        player.rollAngle = 0;

        // Clear
        [...bullets,...enemies,...enemyBullets,...powerups].forEach(e => scene.remove(e.mesh));
        explosions.forEach(e => scene.remove(e.mesh));
        shockwaves.forEach(e => scene.remove(e.mesh));
        hitSparks.forEach(e => scene.remove(e.mesh));
        smokeParticles.forEach(e => scene.remove(e.mesh));
        bullets = []; enemies = []; enemyBullets = []; explosions = []; shockwaves = []; powerups = []; hitSparks = []; smokeParticles = [];
        if(boss) { scene.remove(boss.mesh); boss = null; }
        if(currentAce) { scene.remove(currentAce.mesh); currentAce = null; }
        document.getElementById('bossUI').style.display = 'none';
        lockedTarget = null; lockProgress = 0;

        // Init wingmen
        wingmen.forEach((w,i) => {
          w.status = 'active';
          w.health = 100;
          if(w.mesh) scene.remove(w.mesh);
          w.mesh = createWingman(w.position);
        });

        updateUI();
      }

      function endGame() {
        gameRunning = false;
        stopMusic();
        if(isMobile) document.getElementById('mobileControls').classList.remove('active');
        else document.exitPointerLock();
        stats.totalDeaths++;
        const xp = Math.floor(score/10);
        pilotXP += xp;
        document.getElementById('finalScore').textContent = score.toLocaleString();
        document.getElementById('finalKills').textContent = kills;
        document.getElementById('finalCombo').textContent = stats.highestCombo;
        document.getElementById('finalCredits').textContent = credits.toLocaleString();
        document.getElementById('xpGained').textContent = xp;
        document.getElementById('gameOverScreen').classList.remove('hidden');
        showScoreCard(false);
        save();
      }

      function showVictoryScreen() {
        gameRunning = false;
        stopMusic();
        if(isMobile) document.getElementById('mobileControls').classList.remove('active');
        else document.exitPointerLock();
        const xp = Math.floor(score/5);
        pilotXP += xp;
        document.getElementById('victoryScore').textContent = score.toLocaleString();
        document.getElementById('victoryKills').textContent = kills;
        document.getElementById('victoryCombo').textContent = stats.highestCombo;
        document.getElementById('victoryCredits').textContent = credits.toLocaleString();
        document.getElementById('victoryXP').textContent = xp;
        document.getElementById('victoryScreen').classList.remove('hidden');
        showScoreCard(true);
        save();
      }

      function togglePause() {
        if(!gameRunning) return;
        gamePaused = !gamePaused;
        if(gamePaused) {
          if(!isMobile) document.exitPointerLock();
          if(isMobile) document.getElementById('mobileControls').classList.remove('active');
          stopMusic(); document.getElementById('pauseScreen').classList.remove('hidden');
        } else {
          if(!isMobile) renderer.domElement.requestPointerLock();
          if(isMobile) document.getElementById('mobileControls').classList.add('active');
          startMusic(); document.getElementById('pauseScreen').classList.add('hidden');
        }
      }

      function hideAllScreens() {
        ['nameScreen','mainMenu','hangarScreen','statsScreen','settingsScreen','tutorialScreen','gameOverScreen','victoryScreen','pauseScreen','leaderboardScreen'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.classList.add('hidden');
        });
      }

      function showMainMenu() {
        hideAllScreens();
        document.getElementById('mainMenu').classList.remove('hidden');
      }

      // ═══════════════════════════════════════════════════════════════
      // PILOT NAME & LEADERBOARD
      // ═══════════════════════════════════════════════════════════════
      let pilotName = localStorage.getItem('starfighterPilotName') || '';

      function getLeaderboard() {
        try { return JSON.parse(localStorage.getItem('starfighterLeaderboard') || '[]'); }
        catch(e) { return []; }
      }

      function addToLeaderboard(name, scoreVal, killsVal, comboVal, rankStr, mode) {
        const lb = getLeaderboard();
        lb.push({
          name: name || 'UNKNOWN',
          score: scoreVal,
          kills: killsVal,
          combo: comboVal,
          rank: rankStr,
          mode: mode,
          date: new Date().toLocaleDateString()
        });
        lb.sort((a,b) => b.score - a.score);
        if(lb.length > 20) lb.length = 20;
        localStorage.setItem('starfighterLeaderboard', JSON.stringify(lb));
        return lb;
      }

      function renderLeaderboard() {
        const lb = getLeaderboard();
        const container = document.getElementById('leaderboardList');
        if(lb.length === 0) {
          container.innerHTML = '<p style="color:#666;text-align:center;">No entries yet. Play a game first!</p>';
          return;
        }
        let html = '<table style="width:100%;border-collapse:collapse;">';
        html += '<tr style="color:#00ff88;font-size:11px;"><th style="padding:8px;text-align:left;">#</th><th style="text-align:left;">PILOT</th><th>SCORE</th><th>KILLS</th><th>COMBO</th><th>RANK</th><th style="font-size:10px;">MODE</th></tr>';
        lb.forEach((entry, i) => {
          const rowColor = i === 0 ? '#ffff00' : i < 3 ? '#00ff88' : '#888';
          const medal = i === 0 ? '&#9733; ' : i === 1 ? '&#9734; ' : i === 2 ? '&#9734; ' : '';
          html += `<tr style="color:${rowColor};font-size:12px;border-top:1px solid #222;">`;
          html += `<td style="padding:6px;">${medal}${i+1}</td>`;
          html += `<td style="font-weight:bold;">${entry.name}</td>`;
          html += `<td style="text-align:center;">${entry.score.toLocaleString()}</td>`;
          html += `<td style="text-align:center;">${entry.kills}</td>`;
          html += `<td style="text-align:center;">${entry.combo}x</td>`;
          html += `<td style="text-align:center;">${entry.rank}</td>`;
          html += `<td style="text-align:center;font-size:10px;color:#555;">${entry.mode}</td>`;
          html += '</tr>';
        });
        html += '</table>';
        container.innerHTML = html;
      }

      // ═══════════════════════════════════════════════════════════════
      // SCORE CARD GENERATION
      // ═══════════════════════════════════════════════════════════════
      function generateScoreCard(name, scoreVal, killsVal, comboVal, rankStr, mode, victory) {
        const canvas = document.getElementById('scoreCardCanvas');
        const ctx = canvas.getContext('2d');

        // Background
        const bg = ctx.createLinearGradient(0,0,600,400);
        bg.addColorStop(0, '#000a15');
        bg.addColorStop(1, '#0a0020');
        ctx.fillStyle = bg;
        ctx.fillRect(0,0,600,400);

        // Border
        ctx.strokeStyle = victory ? '#00ff88' : '#ff0055';
        ctx.lineWidth = 3;
        ctx.strokeRect(5,5,590,390);

        // Inner border
        ctx.strokeStyle = 'rgba(0,255,136,0.2)';
        ctx.lineWidth = 1;
        ctx.strokeRect(15,15,570,370);

        // Title
        ctx.font = 'bold 28px "Courier New", monospace';
        ctx.fillStyle = '#00ff88';
        ctx.textAlign = 'center';
        ctx.shadowColor = '#00ff88';
        ctx.shadowBlur = 15;
        ctx.fillText('STARFIGHTER LEGENDARY', 300, 50);
        ctx.shadowBlur = 0;

        // Result
        ctx.font = 'bold 22px "Courier New", monospace';
        ctx.fillStyle = victory ? '#00ff88' : '#ff0055';
        ctx.fillText(victory ? 'MISSION COMPLETE' : 'MISSION FAILED', 300, 85);

        // Pilot name
        ctx.font = '16px "Courier New", monospace';
        ctx.fillStyle = '#00aaff';
        ctx.fillText('PILOT: ' + (name || 'UNKNOWN'), 300, 115);

        // Stats box
        ctx.fillStyle = 'rgba(0,30,20,0.6)';
        ctx.fillRect(50, 135, 500, 180);
        ctx.strokeStyle = 'rgba(0,255,136,0.3)';
        ctx.strokeRect(50, 135, 500, 180);

        // Score
        ctx.font = 'bold 42px "Courier New", monospace';
        ctx.fillStyle = '#ffffff';
        ctx.shadowColor = '#00ff88';
        ctx.shadowBlur = 10;
        ctx.fillText(scoreVal.toLocaleString(), 300, 185);
        ctx.shadowBlur = 0;

        ctx.font = '12px "Courier New", monospace';
        ctx.fillStyle = '#666';
        ctx.fillText('SCORE', 300, 200);

        // Stats row
        ctx.font = 'bold 24px "Courier New", monospace';
        ctx.textAlign = 'center';

        ctx.fillStyle = '#ff0055';
        ctx.fillText(killsVal.toString(), 150, 250);
        ctx.font = '10px "Courier New", monospace';
        ctx.fillStyle = '#888';
        ctx.fillText('KILLS', 150, 265);

        ctx.font = 'bold 24px "Courier New", monospace';
        ctx.fillStyle = '#ffaa00';
        ctx.fillText(comboVal + 'x', 300, 250);
        ctx.font = '10px "Courier New", monospace';
        ctx.fillStyle = '#888';
        ctx.fillText('BEST COMBO', 300, 265);

        ctx.font = 'bold 24px "Courier New", monospace';
        ctx.fillStyle = '#00aaff';
        ctx.fillText(rankStr, 450, 250);
        ctx.font = '10px "Courier New", monospace';
        ctx.fillStyle = '#888';
        ctx.fillText('RANK', 450, 265);

        // Mode
        ctx.font = '12px "Courier New", monospace';
        ctx.fillStyle = '#555';
        ctx.fillText('MODE: ' + mode.toUpperCase(), 300, 300);

        // Footer
        ctx.font = '11px "Courier New", monospace';
        ctx.fillStyle = '#333';
        ctx.fillText('Can you beat this score? Play at the link below!', 300, 355);

        // Stars decoration
        for(let i=0;i<50;i++) {
          ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.5})`;
          ctx.fillRect(Math.random()*600, Math.random()*400, 1, 1);
        }

        return canvas.toDataURL('image/png');
      }

      function showScoreCard(victory) {
        const rankStr = ranks[pilotRank] || 'ROOKIE';
        const imgData = generateScoreCard(pilotName, score, kills, stats.highestCombo, rankStr, gameMode, victory);

        addToLeaderboard(pilotName, score, kills, stats.highestCombo, rankStr, gameMode);

        if(victory) {
          document.getElementById('victoryCardPreview').style.display = 'block';
          document.getElementById('victoryCardImg').src = imgData;
        } else {
          document.getElementById('scoreCardPreview').style.display = 'block';
          document.getElementById('scoreCardImg').src = imgData;
        }
      }

      function shareScoreCard() {
        const canvas = document.getElementById('scoreCardCanvas');
        canvas.toBlob(blob => {
          if(navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], 'starfighter-score.png', { type: 'image/png' })] })) {
            navigator.share({
              title: 'STARFIGHTER LEGENDARY - My Score',
              text: `I scored ${score.toLocaleString()} in STARFIGHTER LEGENDARY! Can you beat me?`,
              files: [new File([blob], 'starfighter-score.png', { type: 'image/png' })]
            }).catch(() => downloadScoreCard());
          } else {
            downloadScoreCard();
          }
        });
      }

      function downloadScoreCard() {
        const canvas = document.getElementById('scoreCardCanvas');
        const link = document.createElement('a');
        link.download = 'starfighter-score-' + Date.now() + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }

      // ═══════════════════════════════════════════════════════════════
      // SAVE/LOAD
      // ═══════════════════════════════════════════════════════════════
      function save() {
        localStorage.setItem('starfighterUltimateSave', JSON.stringify({
          credits, pilotXP, pilotRank, settings, stats, selectedShip, shipColor,
          weapons: weapons.map(w => w.unlocked),
          ships: shipTypes.map(s => s.unlocked)
        }));
      }

      function load() {
        const data = localStorage.getItem('starfighterUltimateSave');
        if(!data) return;
        try {
          const parsed = JSON.parse(data);
          credits = parsed.credits || 0;
          pilotXP = parsed.pilotXP || 0;
          pilotRank = parsed.pilotRank || 0;
          if(parsed.settings) Object.assign(settings, parsed.settings);
          if(parsed.stats) Object.assign(stats, parsed.stats);
          selectedShip = parsed.selectedShip || 0;
          shipColor = parsed.shipColor || 0x00ff88;
          if(parsed.weapons) parsed.weapons.forEach((u,i) => { if(weapons[i]) weapons[i].unlocked = u; });
          if(parsed.ships) parsed.ships.forEach((u,i) => { if(shipTypes[i]) shipTypes[i].unlocked = u; });
        } catch(e){}
      }

      // ═══════════════════════════════════════════════════════════════
      // UI SETUP
      // ═══════════════════════════════════════════════════════════════
      function renderShipSelect() {
        const container = document.getElementById('shipSelect');
        container.innerHTML = '';
        shipTypes.forEach((s,i) => {
          const card = document.createElement('div');
          card.className = 'ship-card' + (i===selectedShip?' selected':'') + (s.unlocked?'':' locked');
          card.innerHTML = `<div class="ship-preview"><canvas width="80" height="60"></canvas></div><div class="ship-name">${s.name}</div><div class="ship-stats">SPD:${s.speed} HP:${s.health} SH:${s.shield}</div>${s.unlocked?'':`<div class="ship-unlock">$${s.cost}</div>`}`;
          if(s.unlocked) card.onclick = () => { selectedShip = i; renderShipSelect(); };
          else if(credits >= s.cost) card.onclick = () => { credits -= s.cost; s.unlocked = true; selectedShip = i; save(); renderShipSelect(); };
          container.appendChild(card);
        });
      }

      function renderStats() {
        const grid = document.getElementById('statsGrid');
        grid.innerHTML = '';
        const statsList = [
          { label:'Total Kills', value:stats.totalKills },
          { label:'Deaths', value:stats.totalDeaths },
          { label:'Bosses Killed', value:stats.bossesKilled },
          { label:'Highest Combo', value:stats.highestCombo+'x' },
          { label:'Accuracy', value:stats.totalShots>0?Math.floor(stats.totalHits/stats.totalShots*100)+'%':'0%' },
          { label:'Time Played', value:Math.floor(stats.timePlayed/60)+'m' },
          { label:'Missions Done', value:stats.missionsCompleted },
          { label:'Total Credits', value:'$'+stats.totalCredits },
          { label:'Pilot Rank', value:ranks[pilotRank] }
        ];
        statsList.forEach(s => {
          const card = document.createElement('div');
          card.className = 'stats-card';
          card.innerHTML = `<div class="value">${s.value}</div><div class="label">${s.label}</div>`;
          grid.appendChild(card);
        });
      }

      function nextTutorialStep() {
        tutorialStep++;
        if(tutorialStep >= tutorialSteps.length) { hideAllScreens(); showMainMenu(); tutorialStep = 0; return; }
        const step = tutorialSteps[tutorialStep];
        document.getElementById('tutorialTitle').textContent = step.title;
        document.getElementById('tutorialText').textContent = step.text;
        document.getElementById('tutorialKeys').textContent = step.keys;
      }

      // ═══════════════════════════════════════════════════════════════
      // INPUT
      // ═══════════════════════════════════════════════════════════════
      document.addEventListener('keydown', e => {
        keys[e.key] = true;
        if(e.key === 'Escape') togglePause();
        if(e.key === 'v' || e.key === 'V') {
          firstPerson = !firstPerson;
          document.getElementById('viewIndicator').textContent = firstPerson ? 'COCKPIT VIEW [V to toggle]' : 'THIRD PERSON [V to toggle]';
        }
        if(e.key === 'm' || e.key === 'M') { muted = !muted; if(muted) stopMusic(); else if(gameRunning && !gamePaused) startMusic(); }
        ['1','2','3','4','5'].forEach((k,i) => { if(e.key === k && weapons[i] && weapons[i].unlocked) { currentWeapon = i; railgunCharge = 0; }});
      });
      document.addEventListener('keyup', e => { keys[e.key] = false; });
      document.addEventListener('mousemove', e => { if(isPointerLocked) { mouseDeltaX += e.movementX; mouseDeltaY += e.movementY; }});
      document.addEventListener('mousedown', e => { if(e.button === 0) shooting = true; });
      document.addEventListener('mouseup', e => { if(e.button === 0) shooting = false; });
      document.addEventListener('pointerlockchange', () => { isPointerLocked = document.pointerLockElement === renderer.domElement; });

      // Name entry
      document.getElementById('nameConfirmBtn').onclick = () => {
        const name = document.getElementById('pilotNameInput').value.trim().toUpperCase() || 'PILOT';
        pilotName = name;
        localStorage.setItem('starfighterPilotName', pilotName);
        document.getElementById('pilotNameDisplay').textContent = pilotName;
        hideAllScreens();
        document.getElementById('mainMenu').classList.remove('hidden');
      };
      document.getElementById('pilotNameInput').addEventListener('keydown', e => {
        if(e.key === 'Enter') document.getElementById('nameConfirmBtn').click();
      });
      document.getElementById('leaderboardBtn').onclick = () => {
        hideAllScreens();
        renderLeaderboard();
        document.getElementById('leaderboardScreen').classList.remove('hidden');
      };
      // If pilot name already saved, skip to main menu
      if(pilotName) {
        document.getElementById('pilotNameDisplay').textContent = pilotName;
        document.getElementById('nameScreen').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
      }

      // Buttons
      document.getElementById('menuCampaign').onclick = () => { initAudio(); startGame('campaign'); };
      document.getElementById('menuSurvival').onclick = () => { initAudio(); startGame('survival'); };
      document.getElementById('menuTimeAttack').onclick = () => { initAudio(); startGame('timeAttack'); };
      document.getElementById('menuBossRush').onclick = () => { initAudio(); startGame('bossRush'); };
      document.getElementById('menuHangar').onclick = () => { hideAllScreens(); renderShipSelect(); document.getElementById('hangarScreen').classList.remove('hidden'); };
      document.getElementById('menuStats').onclick = () => { hideAllScreens(); renderStats(); document.getElementById('statsScreen').classList.remove('hidden'); };
      document.getElementById('menuSettings').onclick = () => { hideAllScreens(); document.getElementById('settingsScreen').classList.remove('hidden'); };
      document.getElementById('menuTutorial').onclick = () => { hideAllScreens(); tutorialStep = 0; const s = tutorialSteps[0]; document.getElementById('tutorialTitle').textContent = s.title; document.getElementById('tutorialText').textContent = s.text; document.getElementById('tutorialKeys').textContent = s.keys; document.getElementById('tutorialScreen').classList.remove('hidden'); };
      document.getElementById('menuLeaderboard').onclick = () => { hideAllScreens(); renderLeaderboard(); document.getElementById('leaderboardScreen').classList.remove('hidden'); };
      document.getElementById('leaderboardBack').onclick = showMainMenu;
      document.getElementById('hangarBack').onclick = showMainMenu;
      document.getElementById('statsBack').onclick = showMainMenu;
      document.getElementById('settingsBack').onclick = () => { save(); showMainMenu(); };
      document.getElementById('tutorialNext').onclick = nextTutorialStep;
      document.getElementById('tutorialSkip').onclick = showMainMenu;
      document.getElementById('retryBtn').onclick = () => { document.getElementById('gameOverScreen').classList.add('hidden'); startGame(gameMode); };
      document.getElementById('menuBtn').onclick = () => { document.getElementById('gameOverScreen').classList.add('hidden'); showMainMenu(); };
      document.getElementById('shareBtn').onclick = shareScoreCard;
      document.getElementById('victoryShareBtn').onclick = shareScoreCard;
      document.getElementById('nextMissionBtn').onclick = () => { document.getElementById('victoryScreen').classList.add('hidden'); startGame(gameMode); };
      document.getElementById('victoryMenuBtn').onclick = () => { document.getElementById('victoryScreen').classList.add('hidden'); showMainMenu(); };
      document.getElementById('resumeBtn').onclick = togglePause;
      document.getElementById('pauseMenuBtn').onclick = () => { gameRunning = false; document.getElementById('pauseScreen').classList.add('hidden'); showMainMenu(); };

      // Settings
      document.getElementById('sensitivitySlider').oninput = e => { settings.sensitivity = parseInt(e.target.value); };
      document.getElementById('volumeSlider').oninput = e => { settings.volume = parseInt(e.target.value); };
      document.getElementById('voiceToggle').onclick = e => { settings.voiceAlerts = !settings.voiceAlerts; e.target.classList.toggle('on', settings.voiceAlerts); };
      document.getElementById('musicToggle').onclick = e => { settings.music = !settings.music; e.target.classList.toggle('on', settings.music); if(!settings.music) stopMusic(); };
      document.getElementById('shipColor').oninput = e => { shipColor = parseInt(e.target.value.slice(1), 16); };

      window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

      // ═══════════════════════════════════════════════════════════════
      // MOBILE TOUCH CONTROLS
      // ═══════════════════════════════════════════════════════════════
      if(isMobile) {
        // Show touch controls and adjust renderer
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));

        // Build touch weapon bar
        const weaponBar = document.getElementById('touchWeaponBar');
        weapons.forEach((w, i) => {
          const btn = document.createElement('div');
          btn.className = 'touch-weapon-btn' + (i === 0 ? ' active' : '') + (w.unlocked ? '' : ' locked');
          btn.textContent = (i+1);
          btn.dataset.idx = i;
          btn.addEventListener('touchstart', e => {
            e.preventDefault();
            if(weapons[i].unlocked) {
              currentWeapon = i;
              railgunCharge = 0;
              document.querySelectorAll('.touch-weapon-btn').forEach((b,j) => b.classList.toggle('active', j === i));
            }
          }, {passive:false});
          weaponBar.appendChild(btn);
        });

        // Joystick
        const joystickBase = document.getElementById('joystickBase');
        const joystickThumb = document.getElementById('joystickThumb');
        let joystickActive = false, joystickId = null;
        const joystickCenter = { x: 70, y: 70 };
        const joystickMax = 55;

        document.getElementById('joystickArea').addEventListener('touchstart', e => {
          e.preventDefault();
          const t = e.changedTouches[0];
          joystickActive = true;
          joystickId = t.identifier;
          updateJoystick(t);
        }, {passive:false});

        document.addEventListener('touchmove', e => {
          if(!joystickActive) return;
          for(let i=0; i<e.changedTouches.length; i++) {
            if(e.changedTouches[i].identifier === joystickId) {
              updateJoystick(e.changedTouches[i]);
              break;
            }
          }
        }, {passive:false});

        document.addEventListener('touchend', e => {
          for(let i=0; i<e.changedTouches.length; i++) {
            if(e.changedTouches[i].identifier === joystickId) {
              joystickActive = false;
              joystickId = null;
              joystickThumb.style.transform = 'translate(-50%, -50%)';
              joystickDX = 0; joystickDY = 0;
              break;
            }
          }
        });

        function updateJoystick(touch) {
          const rect = joystickBase.getBoundingClientRect();
          let dx = touch.clientX - (rect.left + rect.width/2);
          let dy = touch.clientY - (rect.top + rect.height/2);
          const dist = Math.sqrt(dx*dx + dy*dy);
          if(dist > joystickMax) { dx = dx/dist*joystickMax; dy = dy/dist*joystickMax; }
          joystickThumb.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
          joystickDX = dx / joystickMax; // -1 to 1
          joystickDY = dy / joystickMax; // -1 to 1
        }

        // Fire button
        const fireBtn = document.getElementById('fireBtn');
        fireBtn.addEventListener('touchstart', e => { e.preventDefault(); shooting = true; fireBtn.classList.add('active'); }, {passive:false});
        fireBtn.addEventListener('touchend', e => { e.preventDefault(); shooting = false; fireBtn.classList.remove('active'); }, {passive:false});
        fireBtn.addEventListener('touchcancel', e => { shooting = false; fireBtn.classList.remove('active'); });

        // Thrust button (auto-forward)
        const thrustBtn = document.getElementById('thrustBtn');
        thrustBtn.addEventListener('touchstart', e => { e.preventDefault(); touchThrust = true; keys['w'] = true; thrustBtn.classList.add('active'); }, {passive:false});
        thrustBtn.addEventListener('touchend', e => { e.preventDefault(); touchThrust = false; keys['w'] = false; thrustBtn.classList.remove('active'); }, {passive:false});
        thrustBtn.addEventListener('touchcancel', e => { touchThrust = false; keys['w'] = false; thrustBtn.classList.remove('active'); });

        // Boost button
        const boostBtn = document.getElementById('boostBtn');
        boostBtn.addEventListener('touchstart', e => { e.preventDefault(); touchBoosting = true; keys['Shift'] = true; keys['w'] = true; boostBtn.classList.add('active'); }, {passive:false});
        boostBtn.addEventListener('touchend', e => { e.preventDefault(); touchBoosting = false; keys['Shift'] = false; if(!touchThrust) keys['w'] = false; boostBtn.classList.remove('active'); }, {passive:false});
        boostBtn.addEventListener('touchcancel', e => { touchBoosting = false; keys['Shift'] = false; if(!touchThrust) keys['w'] = false; boostBtn.classList.remove('active'); });

        // Lock button
        const lockBtn = document.getElementById('lockBtn');
        lockBtn.addEventListener('touchstart', e => { e.preventDefault(); keys['Tab'] = true; }, {passive:false});
        lockBtn.addEventListener('touchend', e => { e.preventDefault(); keys['Tab'] = false; }, {passive:false});
        lockBtn.addEventListener('touchcancel', e => { keys['Tab'] = false; });

        // Prevent default touch behavior on game area
        renderer.domElement.addEventListener('touchstart', e => e.preventDefault(), {passive:false});
        renderer.domElement.addEventListener('touchmove', e => e.preventDefault(), {passive:false});
      }

      // ═══════════════════════════════════════════════════════════════
      // GAME LOOP
      // ═══════════════════════════════════════════════════════════════
      let lastTime = 0;
      function gameLoop(currentTime) {
        const dt = Math.min(currentTime - lastTime, 50);
        lastTime = currentTime;
        update(dt);
        renderer.render(scene, camera);
        requestAnimationFrame(gameLoop);
      }

      // Init
      load();
      renderWeaponSlots();
      requestAnimationFrame(gameLoop);
      console.log('Starfighter Ultimate initialized!');
    };
  </script>
</body>
</html>
